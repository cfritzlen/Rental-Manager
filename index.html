<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental Management System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .main {
            padding: 40px 0;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .card-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        input, select, textarea {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-tertiary);
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }

        td {
            font-size: 14px;
            color: var(--text-primary);
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-expiring {
            background: #fef3c7;
            color: #92400e;
        }

        .status-expired {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--bg-tertiary);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            max-width: 500px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">Rental Management</div>
                <nav class="nav">
                    <button class="nav-btn active" onclick="showView('dashboard')">Dashboard</button>
                    <button class="nav-btn" onclick="resetAndShowNewLease()">New Lease</button>
                    <button class="nav-btn" onclick="showView('leases')">All Leases</button>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Properties</div>
                        <div class="stat-value" id="stat-properties">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Leases</div>
                        <div class="stat-value" id="stat-active">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Expiring Soon (30 days)</div>
                        <div class="stat-value" id="stat-expiring">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Monthly Revenue</div>
                        <div class="stat-value" id="stat-revenue">$0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Upcoming Renewals</div>
                    <div id="renewals-container"></div>
                </div>
            </div>

            <!-- New Lease View -->
            <div id="new-lease" class="view">
                <div class="card">
                    <div class="card-header">Create New Lease Agreement</div>
                    <div id="alert-container"></div>
                    
                    <form id="lease-form">
                        <!-- Hidden field to track if this is a renewal -->
                        <input type="hidden" name="is_renewal" id="is-renewal" value="false">
                        <input type="hidden" name="previous_lease_id" id="previous-lease-id" value="">
                        
                        <div class="card-header" style="font-size: 16px; margin-bottom: 15px;">Lease Configuration</div>
                        
                        <!-- Renewal indicator - shown when renewing -->
                        <div id="renewal-indicator" style="display: none; background: #dbeafe; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                            <strong>üîÑ Renewing Existing Lease</strong>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #1e40af;">All data pre-filled from previous lease. Update as needed.</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Number of Tenants *</label>
                                <select name="tenant_count" id="tenant-count" required onchange="updateTenantSections()">
                                    <option value="1">1 Tenant</option>
                                    <option value="2">2 Tenants</option>
                                    <option value="3">3 Tenants</option>
                                    <option value="4">4 Tenants</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tenant 1 -->
                        <div id="tenant1-section">
                            <div class="card-header" style="font-size: 16px; margin-top: 20px; margin-bottom: 15px;">Tenant 1 *</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name *</label>
                                    <input type="text" name="tenant1_name" id="tenant1_name" required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="tenant1_email">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" name="tenant1_phone">
                                </div>
                                <div class="form-group">
                                    <label>Employer</label>
                                    <input type="text" name="tenant1_employer">
                                </div>
                            </div>
                        </div>

                        <!-- Tenant 2 -->
                        <div id="tenant2-section" style="display: none;">
                            <div class="card-header" style="font-size: 16px; margin-top: 20px; margin-bottom: 15px;">Tenant 2</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" name="tenant2_name" id="tenant2_name">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="tenant2_email">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" name="tenant2_phone">
                                </div>
                                <div class="form-group">
                                    <label>Employer</label>
                                    <input type="text" name="tenant2_employer">
                                </div>
                            </div>
                        </div>

                        <!-- Tenant 3 -->
                        <div id="tenant3-section" style="display: none;">
                            <div class="card-header" style="font-size: 16px; margin-top: 20px; margin-bottom: 15px;">Tenant 3</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" name="tenant3_name" id="tenant3_name">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="tenant3_email">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" name="tenant3_phone">
                                </div>
                                <div class="form-group">
                                    <label>Employer</label>
                                    <input type="text" name="tenant3_employer">
                                </div>
                            </div>
                        </div>

                        <!-- Tenant 4 -->
                        <div id="tenant4-section" style="display: none;">
                            <div class="card-header" style="font-size: 16px; margin-top: 20px; margin-bottom: 15px;">Tenant 4</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" name="tenant4_name" id="tenant4_name">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="tenant4_email">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" name="tenant4_phone">
                                </div>
                                <div class="form-group">
                                    <label>Employer</label>
                                    <input type="text" name="tenant4_employer">
                                </div>
                            </div>
                        </div>

                        <div class="card-header" style="font-size: 16px; margin-top: 30px; margin-bottom: 15px;">Property Information</div>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Property & Unit *</label>
                                <select name="property_address" required>
                                    <option value="">Select Property</option>
                                    <option value="180 N Courtland St, Unit 180A, East Stroudsburg, PA 18301">180 N Courtland St - Unit 180A</option>
                                    <option value="180 N Courtland St, Unit 180B, East Stroudsburg, PA 18301">180 N Courtland St - Unit 180B</option>
                                    <option value="180 N Courtland St, Unit 182A, East Stroudsburg, PA 18301">180 N Courtland St - Unit 182A</option>
                                    <option value="180 N Courtland St, Unit 182B, East Stroudsburg, PA 18301">180 N Courtland St - Unit 182B</option>
                                    <option value="503 Lindbergh Ave, 1st Floor, Stroudsburg, PA 18360">503 Lindbergh Ave - 1st Floor</option>
                                    <option value="503 Lindbergh Ave, 2nd Floor, Stroudsburg, PA 18360">503 Lindbergh Ave - 2nd Floor</option>
                                    <option value="1028 Poplar Valley Rd, Stroudsburg, PA 18360">1028 Poplar Valley Rd - Single Family</option>
                                    <option value="1038 Poplar Valley Rd, Upstairs, Stroudsburg, PA 18360">1038 Poplar Valley Rd - Upstairs</option>
                                    <option value="1038 Poplar Valley Rd, Downstairs, Stroudsburg, PA 18360">1038 Poplar Valley Rd - Downstairs</option>
                                </select>
                            </div>
                        </div>

                        <div class="card-header" style="font-size: 16px; margin-top: 30px; margin-bottom: 15px;">Lease Terms</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Lease Start Date *</label>
                                <input type="date" name="lease_start" required onchange="calculateEndDate()">
                            </div>
                            <div class="form-group">
                                <label>Lease Duration *</label>
                                <select name="lease_type" required onchange="calculateEndDate()">
                                    <option value="">Select Duration</option>
                                    <option value="month_to_month">Month-to-Month</option>
                                    <option value="12_month">12 Months</option>
                                    <option value="24_month">24 Months</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Lease End Date</label>
                                <input type="date" name="lease_end" readonly style="background: #f1f5f9;">
                            </div>
                            <div class="form-group">
                                <label>Lease Period (months)</label>
                                <input type="number" name="lease_months" readonly style="background: #f1f5f9;">
                            </div>
                        </div>

                        <div class="card-header" style="font-size: 16px; margin-top: 30px; margin-bottom: 15px;">Financial Terms</div>
                        
                        <!-- Renewal rent increase section - only shown for renewals -->
                        <div id="renewal-rent-section" style="display: none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Previous Monthly Rent</label>
                                    <input type="number" id="previous-rent" step="0.01" readonly style="background: #f1f5f9;">
                                </div>
                                <div class="form-group">
                                    <label>Rent Increase % *</label>
                                    <input type="number" id="rent-increase-percent" step="0.01" min="0" max="100" placeholder="e.g., 5, 8, 20" onchange="calculateRenewalRent()">
                                </div>
                                <div class="form-group">
                                    <label>New Monthly Rent *</label>
                                    <input type="number" id="rent-amount-renewal" step="0.01" readonly style="background: #f1f5f9;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Initial lease rent - shown for new leases -->
                        <div id="initial-rent-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Monthly Rent Amount *</label>
                                    <input type="number" id="rent-amount-initial" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden field that will hold the actual rent_amount for form submission -->
                        <input type="hidden" name="rent_amount" id="rent-amount-hidden">

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Security Deposit</label>
                                <input type="number" name="security_deposit" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>First Month Rent</label>
                                <input type="number" name="first_month_rent" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Last Month Rent</label>
                                <input type="number" name="last_month_rent" step="0.01">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Number of Cats</label>
                                <input type="number" name="num_cats" value="0" min="0" onchange="calculatePetFees()">
                            </div>
                            <div class="form-group">
                                <label>Monthly Cat Fee (per cat)</label>
                                <input type="number" name="cat_fee" value="0" step="0.01" onchange="calculatePetFees()">
                            </div>
                            <div class="form-group">
                                <label>Number of Dogs</label>
                                <input type="number" name="num_dogs" value="0" min="0" onchange="calculatePetFees()">
                            </div>
                            <div class="form-group">
                                <label>Monthly Dog Fee (per dog)</label>
                                <input type="number" name="dog_fee" value="0" step="0.01" onchange="calculatePetFees()">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Additional Notes</label>
                                <textarea name="notes" rows="4"></textarea>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('lease-form').reset()">Clear Form</button>
                            <button type="submit" class="btn btn-primary">Save & Generate PDF</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- All Leases View -->
            <div id="leases" class="view">
                <div class="card">
                    <div class="card-header">All Lease Agreements</div>
                    <div class="search-bar">
                        <input type="text" placeholder="Search by tenant, property, or address..." onkeyup="filterLeases(this.value)">
                    </div>
                    <div class="table-container">
                        <table id="leases-table">
                            <thead>
                                <tr>
                                    <th>Tenant</th>
                                    <th>Property</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Monthly Rent</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leases-tbody">
                                <tr><td colspan="8" class="loading">Loading leases...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://fzjzzujrjqjacbfbwcvd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6anp6dWpyanFqYWNiZmJ3Y3ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODg0NjYsImV4cCI6MjA4NTg2NDQ2Nn0.dwzx43oEMtLVha7WoLWqAkgRPMLzbE0NaOurS_JWyhY';
        
        // Wait for libraries to load and initialize
        let supabaseClient;
        
        function initSupabase() {
            try {
                // For UMD build, supabase is on window
                const { createClient } = window.supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase initialized successfully');
                return true;
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                return false;
            }
        }

        let allLeases = [];

        // Navigation
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(viewName).classList.add('active');
            event.target.classList.add('active');

            if (viewName === 'dashboard') loadDashboard();
            if (viewName === 'leases') loadAllLeases();
        }

        // Reset form and show new lease view (not a renewal)
        function resetAndShowNewLease() {
            // Reset the form
            document.getElementById('lease-form').reset();
            
            // Reset renewal mode
            document.getElementById('is-renewal').value = 'false';
            document.getElementById('previous-lease-id').value = '';
            document.getElementById('renewal-indicator').style.display = 'none';
            document.getElementById('renewal-rent-section').style.display = 'none';
            document.getElementById('initial-rent-section').style.display = 'block';
            
            // Show the view
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('new-lease').classList.add('active');
            event.target.classList.add('active');
            
            // Reset tenant sections
            document.getElementById('tenant-count').value = '1';
            updateTenantSections();
        }

        // Show/hide tenant sections based on count
        function updateTenantSections() {
            const count = parseInt(document.getElementById('tenant-count').value);
            
            for (let i = 1; i <= 4; i++) {
                const section = document.getElementById(`tenant${i}-section`);
                const nameInput = document.getElementById(`tenant${i}_name`);
                
                if (i <= count) {
                    section.style.display = 'block';
                    if (i === 1) {
                        nameInput.required = true;
                    }
                } else {
                    section.style.display = 'none';
                    nameInput.required = false;
                    // Clear hidden fields
                    document.querySelector(`[name="tenant${i}_name"]`).value = '';
                    document.querySelector(`[name="tenant${i}_email"]`).value = '';
                    document.querySelector(`[name="tenant${i}_phone"]`).value = '';
                    document.querySelector(`[name="tenant${i}_employer"]`).value = '';
                }
            }
        }

        // Calculate end date and lease months
        function calculateEndDate() {
            const startDate = document.querySelector('[name="lease_start"]').value;
            const leaseType = document.querySelector('[name="lease_type"]').value;
            
            if (!startDate || !leaseType) return;

            const start = new Date(startDate);
            let end = new Date(start);
            let months = 0;

            switch(leaseType) {
                case 'month_to_month':
                    end.setMonth(end.getMonth() + 1);
                    months = 1;
                    break;
                case '12_month':
                    end.setFullYear(end.getFullYear() + 1);
                    months = 12;
                    break;
                case '24_month':
                    end.setFullYear(end.getFullYear() + 2);
                    months = 24;
                    break;
            }

            document.querySelector('[name="lease_end"]').value = end.toISOString().split('T')[0];
            document.querySelector('[name="lease_months"]').value = months;
        }

        // Calculate new rent for renewals based on % increase
        function calculateRenewalRent() {
            const previousRent = parseFloat(document.getElementById('previous-rent').value) || 0;
            const increasePercent = parseFloat(document.getElementById('rent-increase-percent').value) || 0;
            
            if (previousRent && increasePercent >= 0) {
                const newRent = previousRent * (1 + increasePercent / 100);
                document.getElementById('rent-amount-renewal').value = newRent.toFixed(2);
                document.getElementById('rent-amount-hidden').value = newRent.toFixed(2);
            }
        }

        // Calculate pet fees
        function calculatePetFees() {
            const numCats = parseInt(document.querySelector('[name="num_cats"]').value) || 0;
            const catFee = parseFloat(document.querySelector('[name="cat_fee"]').value) || 0;
            const numDogs = parseInt(document.querySelector('[name="num_dogs"]').value) || 0;
            const dogFee = parseFloat(document.querySelector('[name="dog_fee"]').value) || 0;

            // Just for display purposes - total pet fee
            const totalPetFee = (numCats * catFee) + (numDogs * dogFee);
            console.log('Total monthly pet fee:', totalPetFee);
        }

        // Initialize database
        async function initDatabase() {
            try {
                // Create leases table if it doesn't exist
                const { error } = await supabaseClient.rpc('create_leases_table');
                if (error && !error.message.includes('already exists')) {
                    console.error('Error creating table:', error);
                }
            } catch (e) {
                console.log('Database initialization note:', e.message);
            }
        }

        // Form submission
        document.getElementById('lease-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Copy the correct rent_amount to the hidden field
            const isRenewal = document.getElementById('is-renewal').value === 'true';
            if (isRenewal) {
                // For renewals, value is already set by calculateRenewalRent
                const renewalRent = document.getElementById('rent-amount-renewal').value;
                if (!renewalRent) {
                    showAlert('Please enter a rent increase percentage', 'error');
                    return;
                }
            } else {
                // For initial leases, copy from initial rent field
                const initialRent = document.getElementById('rent-amount-initial').value;
                if (!initialRent) {
                    showAlert('Please enter a rent amount', 'error');
                    return;
                }
                document.getElementById('rent-amount-hidden').value = initialRent;
            }
            
            const formData = new FormData(e.target);
            const leaseData = {};
            
            // Collect all form data
            for (let [key, value] of formData.entries()) {
                leaseData[key] = value;
            }
            
            // Store renewal info for later use, but remove from database save
            const isRenewal = leaseData.is_renewal === 'true';
            const previousLeaseId = leaseData.previous_lease_id;
            delete leaseData.is_renewal;
            delete leaseData.previous_lease_id;
            
            // Build tenant names string for display
            const tenantNames = [];
            if (leaseData.tenant1_name) tenantNames.push(leaseData.tenant1_name);
            if (leaseData.tenant2_name) tenantNames.push(leaseData.tenant2_name);
            if (leaseData.tenant3_name) tenantNames.push(leaseData.tenant3_name);
            if (leaseData.tenant4_name) tenantNames.push(leaseData.tenant4_name);
            leaseData.tenant_names = tenantNames.join(', ');
            
            // Add calculated fields
            leaseData.status = 'active';
            leaseData.created_at = new Date().toISOString();
            leaseData.base_rent = leaseData.rent_amount; // For initial leases, base_rent = rent_amount
            
            try {
                // Save to database
                const { data, error } = await supabaseClient
                    .from('leases')
                    .insert([leaseData])
                    .select();

                if (error) throw error;

                showAlert('Lease saved successfully!', 'success');
                
                // If this is a renewal, terminate the old lease
                if (leaseData.is_renewal === 'true' && leaseData.previous_lease_id) {
                    try {
                        await supabaseClient
                            .from('leases')
                            .update({ status: 'terminated' })
                            .eq('id', leaseData.previous_lease_id);
                    } catch (terminateError) {
                        console.error('Error terminating old lease:', terminateError);
                        // Don't fail the whole process if old lease termination fails
                    }
                }
                
                // Generate PDF
                generatePDF(leaseData);
                
                // Reset form after 2 seconds
                setTimeout(() => {
                    e.target.reset();
                    // Reset renewal mode
                    document.getElementById('is-renewal').value = 'false';
                    document.getElementById('previous-lease-id').value = '';
                    document.getElementById('renewal-indicator').style.display = 'none';
                    document.getElementById('renewal-rent-section').style.display = 'none';
                    document.getElementById('initial-rent-section').style.display = 'block';
                    showView('dashboard');
                }, 2000);

            } catch (error) {
                console.error('Error saving lease:', error);
                showAlert('Error saving lease: ' + error.message, 'error');
            }
        });

        // Generate PDF
        // Generate PDF matching the exact format of the lease page 1
        function generatePDF(leaseData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Use Times Roman font (default)
            doc.setFont('times', 'normal');
            
            let y = 20;
            const leftMargin = 20;
            
            // Title
            doc.setFontSize(14);
            doc.setFont('times', 'bold');
            doc.text('1 - RESIDENTIAL LEASE AGREEMENT', leftMargin, y);
            
            y += 10;
            
            // Renewal indicator if applicable
            if (leaseData.is_renewal === 'true' && leaseData.previous_lease_id) {
                doc.setFontSize(10);
                doc.setFont('times', 'bold');
                doc.text('‚òë', leftMargin, y);
                doc.text('LEASE RENEWAL', leftMargin + 5, y);
                y += 5;
                doc.setFont('times', 'normal');
                doc.setFontSize(9);
                // Note: We don't have the previous lease date in leaseData, so we'll just indicate it's a renewal
                doc.text('This lease renews and replaces the previous lease agreement for this property.', leftMargin + 5, y);
                y += 8;
            }
            
            doc.setFontSize(11);
            doc.setFont('times', 'bold');
            doc.text('1.1 TERMS AND PARTIES', leftMargin, y);
            
            y += 6;
            doc.setFontSize(10);
            doc.setFont('times', 'normal');
            
            // Build the first paragraph with filled in data
            const leaseMonths = leaseData.lease_months || '';
            const leaseStart = leaseData.lease_start || '________';
            const leaseEnd = leaseData.lease_end || '________';
            
            const para1 = `This is a lease for a period of ${leaseMonths} months (the "Lease Term") beginning on ${leaseStart} and ending on ${leaseEnd}.`;
            const splitPara1 = doc.splitTextToSize(para1, 170);
            doc.text(splitPara1, leftMargin, y);
            y += splitPara1.length * 5;
            
            y += 2;
            const para2 = `Between Colette Fritzlen, ("Landlord") and ${leaseData.tenant_names || '________'} ("Tenants").`;
            const splitPara2 = doc.splitTextToSize(para2, 170);
            doc.text(splitPara2, leftMargin, y);
            y += splitPara2.length * 5;
            
            // Tenant information
            y += 3;
            const tenantCount = parseInt(leaseData.tenant_count) || 1;
            
            for (let i = 1; i <= tenantCount; i++) {
                const email = leaseData[`tenant${i}_email`] || '___________________________';
                const phone = leaseData[`tenant${i}_phone`] || '_____________________';
                const employer = leaseData[`tenant${i}_employer`] || '_____________________________________________';
                
                const tenantInfo = `Tenant's Email Address: ${email}  Tenant Telephone Number: ${phone}  Tenant's Employer: ${employer}`;
                const splitTenant = doc.splitTextToSize(tenantInfo, 170);
                doc.text(splitTenant, leftMargin, y);
                y += splitTenant.length * 5;
            }
            
            y += 2;
            const landlordInfo = `Landlord's Email Address: mocopropert908@gmail.com  Landlord's Telephone Number: 570-560-6626`;
            const splitLandlord = doc.splitTextToSize(landlordInfo, 170);
            doc.text(splitLandlord, leftMargin, y);
            y += splitLandlord.length * 5;
            
            y += 8;
            doc.setFont('times', 'bold');
            doc.text('1.2 PROPERTY RENTED', leftMargin, y);
            
            y += 6;
            doc.setFont('times', 'normal');
            doc.text('Landlord leases to Tenant property located at:', leftMargin, y);
            
            y += 5;
            doc.setFont('times', 'bold');
            const splitAddress = doc.splitTextToSize(leaseData.property_address || '________', 170);
            doc.text(splitAddress, leftMargin + 5, y);
            doc.setFont('times', 'normal');
            y += splitAddress.length * 5;
            
            y += 6;
            doc.text('Together with the following furniture and appliances, if any:', leftMargin, y);
            
            y += 5;
            // Appliance checkboxes
            doc.rect(leftMargin + 5, y - 3, 3, 3);
            doc.text('Refrigerator', leftMargin + 10, y);
            doc.rect(leftMargin + 45, y - 3, 3, 3);
            doc.text('Range', leftMargin + 50, y);
            doc.rect(leftMargin + 75, y - 3, 3, 3);
            doc.text('Dishwasher', leftMargin + 80, y);
            doc.rect(leftMargin + 115, y - 3, 3, 3);
            doc.text('Microwave', leftMargin + 120, y);
            doc.rect(leftMargin + 155, y - 3, 3, 3);
            doc.text('Washer/dryer', leftMargin + 160, y);
            
            y += 8;
            doc.text('The Premises shall be occupied only by the Tenant(s) and the following persons:', leftMargin, y);
            y += 5;
            doc.text('_______________________________________________________________________________________', leftMargin, y);
            
            y += 8;
            doc.setFont('times', 'bold');
            doc.text('1.3 COMMON AREAS', leftMargin, y);
            
            y += 6;
            doc.setFont('times', 'normal');
            doc.text('Under no circumstances are common areas to be used for tenant storage.', leftMargin, y);
            
            y += 8;
            doc.setFont('times', 'bold');
            doc.text('1.4 RENT PAYMENTS AND CHARGES', leftMargin, y);
            
            y += 6;
            doc.setFont('times', 'normal');
            const rentAmount = leaseData.rent_amount || '________';
            doc.text(`Tenant Shall pay rent for the Premises in installments of RENT $${rentAmount}`, leftMargin, y);
            
            y += 6;
            const rentText = `Tenant shall pay the rent and all other charges required to be paid under the Lease by submitting payment online or utilizing a 3rd party electronic payment service. Landlord reserves the right to accept or reject payments utilizing other methods including check or money order. No personal checks will be accepted after the fifth day of each month.`;
            const splitRentText = doc.splitTextToSize(rentText, 170);
            doc.text(splitRentText, leftMargin, y);
            y += splitRentText.length * 5;
            
            y += 3;
            const proRataText = `The landlord may appoint an agent to collect the Lease Payment and to perform the Landlord's obligations. If the tenancy starts on a day other than the first day of the month, Tenant shall pay pro-rated rent until the first regular rental payment date.`;
            const splitProRata = doc.splitTextToSize(proRataText, 170);
            doc.text(splitProRata, leftMargin, y);
            y += splitProRata.length * 5;
            
            y += 8;
            doc.setFont('times', 'bold');
            doc.text('1.5 SECURITY DEPOSIT AND ADVANCE RENT', leftMargin, y);
            
            y += 6;
            doc.setFont('times', 'normal');
            const splitDeposit = doc.splitTextToSize('In addition to the Lease Payments described above, Tenant shall pay the following: (check all that apply)', 170);
            doc.text(splitDeposit, leftMargin, y);
            y += splitDeposit.length * 5;
            
            y += 3;
            const firstMonth = leaseData.first_month_rent || '';
            const lastMonth = leaseData.last_month_rent || '';
            const securityDep = leaseData.security_deposit || '';
            
            // First month checkbox
            if (firstMonth) doc.text('‚òë', leftMargin, y);
            else doc.rect(leftMargin, y - 3, 3, 3);
            doc.text(`First month's Rent of $${firstMonth || '________'} due at lease signing.`, leftMargin + 5, y);
            y += 5;
            
            // Last month checkbox
            if (lastMonth) doc.text('‚òë', leftMargin, y);
            else doc.rect(leftMargin, y - 3, 3, 3);
            doc.text(`Last month's Rent of $${lastMonth || '________'} due at lease signing.`, leftMargin + 5, y);
            y += 5;
            
            // Security deposit checkbox
            if (securityDep) doc.text('‚òë', leftMargin, y);
            else doc.rect(leftMargin, y - 3, 3, 3);
            doc.text(`Security Deposit of $${securityDep || '________'} due at lease signing.`, leftMargin + 5, y);
            y += 6;
            
            doc.text('A monthly non-refundable pet fee (if applicable) in the amount of', leftMargin, y);
            y += 5;
            const catFee = leaseData.cat_fee || '';
            const numCats = leaseData.num_cats || '';
            const catTotal = (catFee && numCats) ? (parseFloat(catFee) * parseInt(numCats)).toFixed(2) : '';
            const catLine = `$${catFee || '________'}/month per cat ‚Äì number of cats ${numCats || '___'} - Total Monthly Fee to be paid with rent $${catTotal || '________'}`;
            const splitCat = doc.splitTextToSize(catLine, 165);
            doc.text(splitCat, leftMargin + 5, y);
            y += splitCat.length * 5;
            
            const dogFee = leaseData.dog_fee || '';
            const numDogs = leaseData.num_dogs || '';
            const dogTotal = (dogFee && numDogs) ? (parseFloat(dogFee) * parseInt(numDogs)).toFixed(2) : '';
            const dogLine = `$${dogFee || '________'}/month per dog ‚Äì number of dogs ${numDogs || '___'} - Total Monthly Fee to be paid with rent $${dogTotal || '________'}`;
            const splitDog = doc.splitTextToSize(dogLine, 165);
            doc.text(splitDog, leftMargin + 5, y);
            
            // Add new page for signatures (Page 19)
            doc.addPage();
            y = 20;
            
            // Section 9 - Sign and Accept
            doc.setFontSize(14);
            doc.setFont('times', 'bold');
            doc.text('9. Sign and Accept', leftMargin, y);
            
            y += 10;
            doc.setFontSize(11);
            doc.text('9.1 SIGN BELOW', leftMargin, y);
            
            y += 8;
            doc.setFontSize(10);
            doc.setFont('times', 'normal');
            doc.text('The Lease has been executed by the parties on the dates indicated below.', leftMargin, y);
            
            y += 15;
            
            // Tenant signatures
            const tenantCount = parseInt(leaseData.tenant_count) || 1;
            
            for (let i = 1; i <= tenantCount; i++) {
                const tenantName = leaseData[`tenant${i}_name`] || `Tenant ${i}`;
                
                // X mark
                doc.setFontSize(16);
                doc.text('X', leftMargin, y);
                
                // Signature line
                doc.setFontSize(10);
                doc.line(leftMargin + 10, y, leftMargin + 90, y);
                
                y += 6;
                
                // Name and role
                doc.setFont('times', 'normal');
                doc.text(`${tenantName} - Lessee`, leftMargin + 10, y);
                
                y += 20;
            }
            
            y += 10;
            
            // Landlord signature
            doc.setFontSize(16);
            doc.text('X', leftMargin, y);
            
            // Signature line
            doc.setFontSize(10);
            doc.line(leftMargin + 10, y, leftMargin + 90, y);
            
            y += 6;
            
            // Name and role
            doc.setFont('times', 'normal');
            doc.text('Colette Fritzlen', leftMargin + 10, y);
            y += 5;
            doc.text('Lessor', leftMargin + 10, y);
            
            // Save PDF
            const filename = `Lease_Pages1-19_${leaseData.tenant_names ? leaseData.tenant_names.replace(/\s+/g, '_') : 'Draft'}_${leaseData.lease_start || 'Draft'}.pdf`;
            doc.save(filename);
        }

        // Load dashboard
        async function loadDashboard() {
            try {
                const { data: leases, error } = await supabaseClient
                    .from('leases')
                    .select('*')
                    .order('lease_start', { ascending: false });

                if (error) throw error;

                // Calculate stats
                const today = new Date();
                const activeLeases = leases.filter(l => {
                    const endDate = new Date(l.lease_end);
                    return l.status === 'active' && endDate >= today;
                });
                const uniqueProperties = new Set(leases.map(l => l.property_address)).size;
                
                // Calculate expiring soon (30 days)
                const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
                const expiringSoon = activeLeases.filter(l => {
                    const endDate = new Date(l.lease_end);
                    return endDate >= today && endDate <= thirtyDaysFromNow;
                });

                // Calculate total revenue
                // Get most recent lease per property (excluding terminated)
                const revenueLeases = [];
                const propertiesMap = new Map();
                
                // Get non-terminated leases grouped by property
                const nonTerminatedLeases = leases.filter(l => l.status !== 'terminated');
                
                // For each property, get the most recent lease
                nonTerminatedLeases.forEach(lease => {
                    const existing = propertiesMap.get(lease.property_address);
                    if (!existing || new Date(lease.created_at) > new Date(existing.created_at)) {
                        propertiesMap.set(lease.property_address, lease);
                    }
                });
                
                // Convert map to array and calculate revenue
                const totalRevenue = Array.from(propertiesMap.values())
                    .reduce((sum, l) => sum + parseFloat(l.rent_amount || 0), 0);

                // Update stats
                document.getElementById('stat-properties').textContent = uniqueProperties;
                document.getElementById('stat-active').textContent = activeLeases.length;
                document.getElementById('stat-expiring').textContent = expiringSoon.length;
                document.getElementById('stat-revenue').textContent = `$${totalRevenue.toLocaleString()}`;

                // Show upcoming renewals
                const renewalsHtml = expiringSoon.length > 0 
                    ? expiringSoon.map(lease => `
                        <div style="padding: 12px; border-left: 3px solid #f59e0b; background: #fffbeb; margin-bottom: 8px; border-radius: 4px;">
                            <strong>${lease.tenant_names}</strong> - ${lease.property_address}<br>
                            <small style="color: #92400e;">Expires: ${lease.lease_end}</small>
                        </div>
                    `).join('')
                    : '<p style="color: #64748b;">No leases expiring in the next 30 days.</p>';

                document.getElementById('renewals-container').innerHTML = renewalsHtml;

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load all leases
        async function loadAllLeases() {
            try {
                const { data: leases, error } = await supabaseClient
                    .from('leases')
                    .select('*')
                    .order('lease_start', { ascending: false });

                if (error) throw error;

                allLeases = leases;
                displayLeases(leases);

            } catch (error) {
                console.error('Error loading leases:', error);
                document.getElementById('leases-tbody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; color: #ef4444;">Error loading leases</td></tr>';
            }
        }

        // Display leases in table
        function displayLeases(leases) {
            const tbody = document.getElementById('leases-tbody');
            
            if (leases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No leases found</td></tr>';
                return;
            }

            const today = new Date();
            
            tbody.innerHTML = leases.map(lease => {
                const endDate = new Date(lease.lease_end);
                const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass = 'status-active';
                let statusText = 'Active';
                
                if (lease.status === 'terminated') {
                    statusClass = 'status-expired';
                    statusText = 'Terminated';
                } else if (daysUntilEnd < 0) {
                    statusClass = 'status-expired';
                    statusText = 'Expired';
                } else if (daysUntilEnd <= 30) {
                    statusClass = 'status-expiring';
                    statusText = 'Expiring Soon';
                }

                return `
                    <tr>
                        <td>${lease.tenant_names}</td>
                        <td>${lease.property_address}</td>
                        <td>${lease.lease_start}</td>
                        <td>${lease.lease_end}</td>
                        <td>$${parseFloat(lease.rent_amount).toLocaleString()}</td>
                        <td>${lease.lease_type.replace('_', ' ')}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn btn-primary" onclick="viewLease(${lease.id})">View</button>
                            <button class="action-btn btn-secondary" onclick="regeneratePDF(${lease.id})">PDF</button>
                            ${lease.status === 'active' ? `<button class="action-btn" style="background: #10b981; color: white;" onclick="renewLease(${lease.id})">Renew</button>` : ''}
                            ${lease.status === 'active' ? `<button class="action-btn" style="background: #ef4444; color: white;" onclick="endLease(${lease.id})">End</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter leases
        function filterLeases(searchTerm) {
            const filtered = allLeases.filter(lease => 
                lease.tenant_names.toLowerCase().includes(searchTerm.toLowerCase()) ||
                lease.property_address.toLowerCase().includes(searchTerm.toLowerCase())
            );
            displayLeases(filtered);
        }

        // View lease details
        function viewLease(id) {
            const lease = allLeases.find(l => l.id === id);
            if (lease) {
                alert(`Lease Details:\n\nTenant: ${lease.tenant_names}\nProperty: ${lease.property_address}\nRent: $${lease.rent_amount}\nStart: ${lease.lease_start}\nEnd: ${lease.lease_end}`);
            }
        }

        // Regenerate PDF
        function regeneratePDF(id) {
            const lease = allLeases.find(l => l.id === id);
            if (lease) {
                generatePDF(lease);
            }
        }

        // End a lease
        async function endLease(id) {
            if (!confirm('Are you sure you want to end this lease? This will mark it as terminated.')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('leases')
                    .update({ status: 'terminated' })
                    .eq('id', id);

                if (error) throw error;

                showAlert('Lease ended successfully', 'success');
                loadDashboard();
                loadAllLeases();
            } catch (error) {
                console.error('Error ending lease:', error);
                showAlert('Error ending lease: ' + error.message, 'error');
            }
        }

        // Renew a lease - pre-fills form with existing data
        function renewLease(id) {
            const lease = allLeases.find(l => l.id === id);
            if (!lease) return;

            // Switch to New Lease tab
            showView('new-lease');
            
            // Mark as renewal
            document.getElementById('is-renewal').value = 'true';
            document.getElementById('previous-lease-id').value = id;
            
            // Show renewal indicator
            document.getElementById('renewal-indicator').style.display = 'block';
            document.getElementById('renewal-rent-section').style.display = 'block';
            document.getElementById('initial-rent-section').style.display = 'none';
            
            // Set tenant count
            const tenantCount = parseInt(lease.tenant_count) || 1;
            document.getElementById('tenant-count').value = tenantCount;
            updateTenantSections();
            
            // Fill tenant info
            for (let i = 1; i <= tenantCount; i++) {
                if (lease[`tenant${i}_name`]) {
                    document.querySelector(`[name="tenant${i}_name"]`).value = lease[`tenant${i}_name`] || '';
                    document.querySelector(`[name="tenant${i}_email"]`).value = lease[`tenant${i}_email`] || '';
                    document.querySelector(`[name="tenant${i}_phone"]`).value = lease[`tenant${i}_phone`] || '';
                    document.querySelector(`[name="tenant${i}_employer"]`).value = lease[`tenant${i}_employer`] || '';
                }
            }
            
            // Fill property
            document.querySelector('[name="property_address"]').value = lease.property_address;
            
            // Set previous rent and prepare for increase
            document.getElementById('previous-rent').value = lease.rent_amount;
            document.getElementById('rent-increase-percent').value = '';
            document.getElementById('rent-amount').value = '';
            
            // Fill deposits (can be edited)
            document.querySelector('[name="security_deposit"]').value = lease.security_deposit || '';
            document.querySelector('[name="first_month_rent"]').value = lease.first_month_rent || '';
            document.querySelector('[name="last_month_rent"]').value = lease.last_month_rent || '';
            
            // Fill pet info (defaults from old lease, can be edited)
            document.querySelector('[name="num_cats"]').value = lease.num_cats || 0;
            document.querySelector('[name="cat_fee"]').value = lease.cat_fee || 0;
            document.querySelector('[name="num_dogs"]').value = lease.num_dogs || 0;
            document.querySelector('[name="dog_fee"]').value = lease.dog_fee || 0;
            
            // Fill notes
            document.querySelector('[name="notes"]').value = lease.notes || '';
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            showAlert('Renewing lease - update dates and rent increase %', 'success');
        }

        // Show alerts
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initSupabase();
            loadDashboard();
        });
    </script>
</body>
</html>
