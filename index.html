<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental Management System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .main {
            padding: 40px 0;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .card-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        input, select, textarea {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-tertiary);
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }

        td {
            font-size: 14px;
            color: var(--text-primary);
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-expiring {
            background: #fef3c7;
            color: #92400e;
        }

        .status-expired {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--bg-tertiary);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            max-width: 500px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        /* Expense Styles */
        .expense-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .expense-filters .form-group {
            min-width: 160px;
            flex: 1;
        }

        .expense-filters label {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .expense-filters select,
        .expense-filters input {
            padding: 8px 10px;
            font-size: 13px;
        }

        .expense-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .expense-summary-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .expense-summary-card .label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .expense-summary-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .toggle-form-btn {
            padding: 10px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-form-btn:hover {
            background: var(--primary-dark);
        }

        .expense-form-container {
            display: none;
            margin-bottom: 20px;
        }

        .expense-form-container.visible {
            display: block;
        }

        .export-btn {
            padding: 10px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .export-btn:hover {
            opacity: 0.9;
        }

        .expense-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-bottom: 12px;
            align-items: stretch;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
        }

        .edit-btn {
            background: var(--primary);
            color: white;
        }

        /* Receipt Styles */
        .receipt-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .receipt-upload-area:hover {
            border-color: var(--primary);
            background: rgba(30, 64, 175, 0.03);
        }

        .receipt-upload-area.drag-over {
            border-color: var(--primary);
            background: rgba(30, 64, 175, 0.08);
            border-style: solid;
        }

        .receipt-upload-area input[type="file"] {
            display: none;
        }

        .receipt-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .receipt-upload-label .icon {
            font-size: 28px;
        }

        .receipt-thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .receipt-thumb {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .receipt-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .receipt-thumb .remove-receipt {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .receipt-thumb .pdf-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fee2e2;
            font-size: 14px;
            font-weight: 600;
            color: #991b1b;
            cursor: pointer;
        }

        .receipt-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }

        .receipt-badge:hover {
            background: #bfdbfe;
        }

        /* Lightbox for viewing receipts */
        .receipt-lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .receipt-lightbox.active {
            display: flex;
        }

        .receipt-lightbox img {
            max-width: 90%;
            max-height: 80vh;
            border-radius: 8px;
        }

        .receipt-lightbox .lb-nav {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .receipt-lightbox button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .lb-close {
            background: white;
            color: #333;
        }

        .lb-prev, .lb-next {
            background: var(--primary);
            color: white;
        }

        .uploading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ccc;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* ========== PAYMENTS ========== */
        .payment-month-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .payment-month-nav button {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .payment-month-nav button:hover {
            background: var(--bg-tertiary);
        }

        .payment-month-label {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            min-width: 200px;
            text-align: center;
        }

        .payment-section-header {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 20px 0 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .payment-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr 140px auto;
            gap: 10px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .payment-row.paid {
            opacity: 0.75;
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 10px;
            margin: 4px 0;
        }

        .payment-row .pr-label {
            font-weight: 600;
            font-size: 14px;
        }

        .payment-row .pr-property {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .payment-row .pr-amount {
            font-weight: 600;
            color: var(--primary);
        }

        .payment-row .pr-due {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .payment-row input[type="date"] {
            padding: 6px 8px;
            font-size: 13px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .payment-row input[type="number"] {
            padding: 6px 8px;
            font-size: 13px;
            border: 1px solid var(--border);
            border-radius: 4px;
            width: 100%;
        }

        .payment-row .pr-status {
            text-align: center;
        }

        .paid-check {
            color: var(--success);
            font-size: 20px;
            font-weight: 700;
        }

        .payment-row .pr-actions button {
            padding: 4px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .setup-table {
            width: 100%;
            border-collapse: collapse;
        }

        .setup-table th, .setup-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .setup-table thead {
            background: var(--bg-tertiary);
        }

        .setup-toggle {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .setup-toggle:hover {
            background: var(--bg-tertiary);
        }

        .setup-container {
            display: none;
            margin-bottom: 20px;
        }

        .setup-container.visible {
            display: block;
        }

        .payment-summary-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .payment-summary-bar .ps-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px 20px;
            text-align: center;
        }

        .payment-summary-bar .ps-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .payment-summary-bar .ps-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
        }

        .payment-summary-bar .ps-value.danger {
            color: var(--danger);
        }

        /* ========== MOBILE RESPONSIVE ========== */
        @media (max-width: 768px) {
            .container {
                padding: 0 12px;
            }

            /* Header: stack logo above nav */
            .header {
                padding: 12px 0;
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            .logo {
                font-size: 20px;
            }

            /* Nav: horizontal scroll */
            .nav {
                width: 100%;
                overflow-x: auto;
                gap: 6px;
                padding-bottom: 2px;
                -webkit-overflow-scrolling: touch;
            }

            .nav-btn {
                padding: 8px 14px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Main content */
            .main {
                padding: 16px 0;
            }

            /* Cards */
            .card {
                padding: 16px;
                border-radius: 8px;
            }

            .card-header {
                font-size: 17px;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px;
            }

            /* Stats grid: 2 columns on mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 14px;
            }

            .stat-value {
                font-size: 22px;
            }

            .stat-label {
                font-size: 12px;
            }

            /* Form grid: single column */
            .form-grid {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            /* Expense action buttons */
            .expense-actions {
                flex-direction: row;
                width: 100%;
                justify-content: flex-start;
            }

            .toggle-form-btn,
            .export-btn {
                font-size: 13px;
                padding: 8px 14px;
            }

            /* Expense filters: stack */
            .expense-filters {
                flex-direction: column;
                gap: 10px;
            }

            .expense-filters .form-group {
                min-width: 100%;
            }

            /* Expense summary cards */
            .expense-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .expense-summary-card .value {
                font-size: 20px;
            }

            /* Tables: horizontal scroll */
            .table-container {
                margin: 0 -16px;
                border-radius: 0;
            }

            th, td {
                padding: 10px 8px;
                font-size: 13px;
            }

            .action-btn {
                padding: 5px 8px;
                font-size: 12px;
            }

            /* Search bar full width */
            .search-bar input {
                max-width: 100%;
            }

            /* Receipt upload */
            .receipt-upload-area {
                padding: 14px;
            }

            .receipt-thumb {
                width: 64px;
                height: 64px;
            }

            /* Lightbox */
            .receipt-lightbox img {
                max-width: 95%;
                max-height: 70vh;
            }

            .lb-nav {
                gap: 10px;
            }

            .lb-nav button {
                padding: 8px 14px;
                font-size: 13px;
            }

            /* Payments mobile */
            .payment-row {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                padding: 10px 0;
            }

            .payment-row .pr-label {
                grid-column: 1 / -1;
            }

            .payment-month-label {
                font-size: 17px;
                min-width: 160px;
            }

            .payment-summary-bar {
                gap: 10px;
            }

            .payment-summary-bar .ps-item {
                padding: 10px 14px;
                flex: 1;
                min-width: 100px;
            }

            .payment-summary-bar .ps-value {
                font-size: 18px;
            }

            .setup-table {
                font-size: 13px;
            }

            .setup-table th, .setup-table td {
                padding: 8px 6px;
            }
        }

        /* Extra small phones */
        @media (max-width: 380px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .expense-summary {
                grid-template-columns: 1fr;
            }

            .nav-btn {
                padding: 7px 10px;
                font-size: 12px;
            }

            .expense-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">Rental Management</div>
                <nav class="nav">
                    <button class="nav-btn active" onclick="showView('dashboard')">Dashboard</button>
                    <button class="nav-btn" onclick="resetAndShowNewLease()">New Lease</button>
                    <button class="nav-btn" onclick="showView('leases')">All Leases</button>
                    <button class="nav-btn" onclick="showView('expenses')">Expenses</button>
                    <button class="nav-btn" onclick="showView('payments')">Payments</button>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Properties</div>
                        <div class="stat-value" id="stat-properties">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Leases</div>
                        <div class="stat-value" id="stat-active">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Expiring Soon (30 days)</div>
                        <div class="stat-value" id="stat-expiring">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Monthly Revenue</div>
                        <div class="stat-value" id="stat-revenue">$0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Upcoming Renewals</div>
                    <div id="renewals-container"></div>
                </div>
            </div>

            <!-- New Lease View -->
            <div id="new-lease" class="view">
                <div class="card">
                    <div class="card-header">Create New Lease Agreement</div>
                    <div id="alert-container"></div>
                    
                    <form id="lease-form">
                        <!-- Hidden field to track if this is a renewal -->
                        <input type="hidden" name="is_renewal" id="is-renewal" value="false">
                        <input type="hidden" name="previous_lease_id" id="previous-lease-id" value="">
                        
                        <div class="card-header" style="font-size: 16px; margin-bottom: 15px;">Lease Configuration</div>
                        
                        <!-- Renewal indicator - shown when renewing -->
                        <div id="renewal-indicator" style="display: none; background: #dbeafe; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                            <strong>üîÑ Renewing Existing Lease</strong>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #1e40af;">All data pre-filled from previous lease. Update as needed.</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Number of Tenants *</label>
                                <select name="tenant_count" id="tenant-count" required onchange="updateTenantSections()">
                                    <option value="1">1 Tenant</option>
                                    <option value="2">2 Tenants</option>
                                    <option value="3">3 Tenants</option>
                                    <option value="4">4 Tenants</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tenant 1 -->
                        <div id="tenant1-section">
                            <div class="card-header" style="font-size: 16px; margin-top: 20px; margin-bottom: 15px;">Tenant 1 *</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name *</label>
                                    <input type="text" name="tenant1_name" id="tenant1_name" required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="tenant1_email">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" name="tenant1_phone">
                                </div>
                                <div class="form-group">
                                    <label>Employer</label>
                                    <input type="text" name="tenant1_employer">
                                </div>
                            </div>
                        </div>

                        <!-- Tenant 2 -->
                        <div id="tenant2-section" style="display: none;">
                            <div class="card-header" style="font-size: 16px; margin-top: 20px; margin-bottom: 15px;">Tenant 2</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" name="tenant2_name" id="tenant2_name">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="tenant2_email">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" name="tenant2_phone">
                                </div>
                                <div class="form-group">
                                    <label>Employer</label>
                                    <input type="text" name="tenant2_employer">
                                </div>
                            </div>
                        </div>

                        <!-- Tenant 3 -->
                        <div id="tenant3-section" style="display: none;">
                            <div class="card-header" style="font-size: 16px; margin-top: 20px; margin-bottom: 15px;">Tenant 3</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" name="tenant3_name" id="tenant3_name">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="tenant3_email">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" name="tenant3_phone">
                                </div>
                                <div class="form-group">
                                    <label>Employer</label>
                                    <input type="text" name="tenant3_employer">
                                </div>
                            </div>
                        </div>

                        <!-- Tenant 4 -->
                        <div id="tenant4-section" style="display: none;">
                            <div class="card-header" style="font-size: 16px; margin-top: 20px; margin-bottom: 15px;">Tenant 4</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" name="tenant4_name" id="tenant4_name">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="tenant4_email">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" name="tenant4_phone">
                                </div>
                                <div class="form-group">
                                    <label>Employer</label>
                                    <input type="text" name="tenant4_employer">
                                </div>
                            </div>
                        </div>

                        <div class="card-header" style="font-size: 16px; margin-top: 30px; margin-bottom: 15px;">Property Information</div>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Property & Unit *</label>
                                <select name="property_address" id="property-dropdown" required>
                                    <option value="">Loading properties...</option>
                                </select>
                            </div>
                        </div>

                        <div class="card-header" style="font-size: 16px; margin-top: 30px; margin-bottom: 15px;">Lease Terms</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Lease Start Date *</label>
                                <input type="date" name="lease_start" required onchange="calculateEndDate()">
                            </div>
                            <div class="form-group">
                                <label>Lease Duration *</label>
                                <select name="lease_type" required onchange="calculateEndDate()">
                                    <option value="">Select Duration</option>
                                    <option value="month_to_month">Month-to-Month</option>
                                    <option value="12_month">12 Months</option>
                                    <option value="24_month">24 Months</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Lease End Date</label>
                                <input type="date" name="lease_end" readonly style="background: #f1f5f9;">
                            </div>
                            <div class="form-group">
                                <label>Lease Period (months)</label>
                                <input type="number" name="lease_months" readonly style="background: #f1f5f9;">
                            </div>
                        </div>

                        <div class="card-header" style="font-size: 16px; margin-top: 30px; margin-bottom: 15px;">Financial Terms</div>
                        
                        <!-- Renewal rent increase section - only shown for renewals -->
                        <div id="renewal-rent-section" style="display: none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Previous Monthly Rent</label>
                                    <input type="number" id="previous-rent" step="0.01" readonly style="background: #f1f5f9;">
                                </div>
                                <div class="form-group">
                                    <label>Rent Increase % *</label>
                                    <input type="number" id="rent-increase-percent" step="0.01" min="0" max="100" placeholder="e.g., 5, 8, 20" onchange="calculateRenewalRent()">
                                </div>
                                <div class="form-group">
                                    <label>New Monthly Rent *</label>
                                    <input type="number" id="rent-amount-renewal" step="0.01" readonly style="background: #f1f5f9;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Initial lease rent - shown for new leases -->
                        <div id="initial-rent-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Monthly Rent Amount *</label>
                                    <input type="number" id="rent-amount-initial" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden field that will hold the actual rent_amount for form submission -->
                        <input type="hidden" name="rent_amount" id="rent-amount-hidden">

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Security Deposit</label>
                                <input type="number" name="security_deposit" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>First Month Rent</label>
                                <input type="number" name="first_month_rent" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Last Month Rent</label>
                                <input type="number" name="last_month_rent" step="0.01">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Number of Cats</label>
                                <input type="number" name="num_cats" value="0" min="0" onchange="calculatePetFees()">
                            </div>
                            <div class="form-group">
                                <label>Monthly Cat Fee (per cat)</label>
                                <input type="number" name="cat_fee" value="0" step="0.01" onchange="calculatePetFees()">
                            </div>
                            <div class="form-group">
                                <label>Number of Dogs</label>
                                <input type="number" name="num_dogs" value="0" min="0" onchange="calculatePetFees()">
                            </div>
                            <div class="form-group">
                                <label>Monthly Dog Fee (per dog)</label>
                                <input type="number" name="dog_fee" value="0" step="0.01" onchange="calculatePetFees()">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Additional Notes</label>
                                <textarea name="notes" rows="4"></textarea>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('lease-form').reset()">Clear Form</button>
                            <button type="submit" class="btn btn-primary">Save & Generate PDF</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- All Leases View -->
            <div id="leases" class="view">
                <div class="card">
                    <div class="card-header">All Lease Agreements</div>
                    <div class="search-bar">
                        <input type="text" placeholder="Search by tenant, property, or address..." onkeyup="filterLeases(this.value)">
                    </div>
                    <div class="table-container">
                        <table id="leases-table">
                            <thead>
                                <tr>
                                    <th>Tenant</th>
                                    <th>Property</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Monthly Rent</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leases-tbody">
                                <tr><td colspan="8" class="loading">Loading leases...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expenses View -->
            <div id="expenses" class="view">
                <div class="card">
                    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>Expense Tracking</span>
                        <div class="expense-actions">
                            <button class="export-btn" onclick="exportExpensesCSV()">üì• Export CSV</button>
                            <button class="export-btn" onclick="downloadAllReceipts()" style="background:#1e40af;">üì∑ Download Receipts</button>
                            <button class="toggle-form-btn" onclick="toggleExpenseForm()" id="add-expense-toggle">+ Add Expense</button>
                        </div>
                    </div>
                    <div id="expense-alert-container"></div>

                    <!-- Add Expense Form (hidden by default) -->
                    <div class="expense-form-container" id="expense-form-container">
                        <form id="expense-form" onsubmit="saveExpense(event)">
                            <input type="hidden" id="expense-id" value="">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" id="expense-date" required>
                                </div>
                                <div class="form-group">
                                    <label>Property *</label>
                                    <select id="expense-property" required>
                                        <option value="">Select Property</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Category *</label>
                                    <select id="expense-category" required>
                                        <option value="">Select Category</option>
                                        <option value="Repairs">Repairs</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Water/Sewer">Water/Sewer</option>
                                        <option value="Trash">Trash</option>
                                        <option value="Snow & Landscaping">Snow & Landscaping</option>
                                        <option value="Taxes">Taxes</option>
                                        <option value="Insurance">Insurance</option>
                                        <option value="Utilities">Utilities</option>
                                        <option value="Post Rental">Post Rental</option>
                                        <option value="Upgrades">Upgrades</option>
                                        <option value="Mortgage Payment">Mortgage Payment</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Amount *</label>
                                    <input type="number" id="expense-amount" step="0.01" min="0" required placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Vendor / Payee</label>
                                    <input type="text" id="expense-vendor" placeholder="e.g. Home Depot, Plumber">
                                </div>
                                <div class="form-group">
                                    <label>Martin Hours</label>
                                    <input type="number" id="expense-martin-hours" step="0.25" min="0" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label>Colette Hours</label>
                                    <input type="number" id="expense-colette-hours" step="0.25" min="0" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label>Miles</label>
                                    <input type="number" id="expense-miles" step="0.1" min="0" placeholder="0">
                                </div>
                                <div class="form-group full-width">
                                    <label>Description / Notes</label>
                                    <textarea id="expense-notes" rows="2" placeholder="Brief description of expense"></textarea>
                                </div>
                                <div class="form-group full-width">
                                    <label>Receipts (up to 3 ‚Äî photos or PDFs)</label>
                                    <div class="receipt-upload-area" id="receipt-drop-area">
                                        <div class="receipt-upload-label" onclick="document.getElementById('receipt-input').click()">
                                            <span class="icon">üìé</span>
                                            <span>Tap to take photo, choose files, or drag & drop here</span>
                                        </div>
                                        <input type="file" id="receipt-input" accept="image/*,.heic,.heif,application/pdf" multiple onchange="handleReceiptFiles(this.files)" style="display:none;">
                                    </div>
                                    <div class="receipt-thumbnails" id="receipt-thumbnails"></div>
                                </div>
                            </div>
                            <div style="display:flex;gap:10px;">
                                <button type="submit" class="btn-primary" id="expense-save-btn">Save Expense</button>
                                <button type="button" class="btn-secondary" onclick="cancelExpenseEdit()">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <!-- Filters -->
                    <div class="expense-filters">
                        <div class="form-group">
                            <label>Filter Property</label>
                            <select id="filter-property" onchange="loadExpenses()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filter Category</label>
                            <select id="filter-category" onchange="loadExpenses()">
                                <option value="">All Categories</option>
                                <option value="Repairs">Repairs</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Water/Sewer">Water/Sewer</option>
                                <option value="Trash">Trash</option>
                                <option value="Snow & Landscaping">Snow & Landscaping</option>
                                <option value="Taxes">Taxes</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Post Rental">Post Rental</option>
                                <option value="Upgrades">Upgrades</option>
                                <option value="Mortgage Payment">Mortgage Payment</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>From</label>
                            <input type="date" id="filter-date-from" onchange="loadExpenses()">
                        </div>
                        <div class="form-group">
                            <label>To</label>
                            <input type="date" id="filter-date-to" onchange="loadExpenses()">
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="expense-summary">
                        <div class="expense-summary-card">
                            <div class="label">Total Expenses</div>
                            <div class="value" id="expense-total">$0.00</div>
                        </div>
                        <div class="expense-summary-card">
                            <div class="label"># of Expenses</div>
                            <div class="value" id="expense-count">0</div>
                        </div>
                    </div>

                    <!-- Expenses Table -->
                    <div class="table-container">
                        <table id="expenses-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Property</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Vendor</th>
                                    <th>Martin Hrs</th>
                                    <th>Colette Hrs</th>
                                    <th>Miles</th>
                                    <th>Receipts</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-tbody">
                                <tr><td colspan="10" class="loading">Click "Expenses" tab to load...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payments View -->
            <div id="payments" class="view">
                <div class="card">
                    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                        <span>Rent & Mortgage Payments</span>
                        <button class="setup-toggle" onclick="togglePaymentSetup()" id="setup-toggle-btn">‚öôÔ∏è Payment Setup</button>
                    </div>
                    <div id="payment-alert-container"></div>

                    <!-- Payment Setup (hidden by default) -->
                    <div class="setup-container" id="payment-setup-container">
                        <div class="card" style="background:var(--bg-secondary);margin-bottom:16px;">
                            <div class="card-header" style="font-size:16px;">Add Payment Default</div>
                            <form id="payment-default-form" onsubmit="savePaymentDefault(event)">
                                <input type="hidden" id="pd-id" value="">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Type *</label>
                                        <select id="pd-type" required>
                                            <option value="rent">Rent</option>
                                            <option value="mortgage">Mortgage</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Label * <small>(e.g. "Josh" or "Mortgage")</small></label>
                                        <input type="text" id="pd-label" required placeholder="e.g. Josh, Sarah, Mortgage">
                                    </div>
                                    <div class="form-group">
                                        <label>Property *</label>
                                        <select id="pd-property" required>
                                            <option value="">Select Property</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Default Amount *</label>
                                        <input type="number" id="pd-amount" step="0.01" min="0" required placeholder="0.00">
                                    </div>
                                    <div class="form-group">
                                        <label>Due Day of Month *</label>
                                        <input type="number" id="pd-due-day" min="1" max="31" required placeholder="1">
                                    </div>
                                </div>
                                <div style="display:flex;gap:10px;">
                                    <button type="submit" class="btn-primary" id="pd-save-btn">Save Default</button>
                                    <button type="button" class="btn-secondary" onclick="cancelPdEdit()">Cancel</button>
                                </div>
                            </form>
                        </div>

                        <!-- Existing defaults table -->
                        <div class="table-container">
                            <table class="setup-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Label</th>
                                        <th>Property</th>
                                        <th>Amount</th>
                                        <th>Due Day</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pd-tbody">
                                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Month Navigator -->
                    <div class="payment-month-nav">
                        <button onclick="changePaymentMonth(-1)">‚Üê Prev</button>
                        <div class="payment-month-label" id="payment-month-label">February 2026</div>
                        <button onclick="changePaymentMonth(1)">Next ‚Üí</button>
                    </div>

                    <!-- Summary Bar -->
                    <div class="payment-summary-bar">
                        <div class="ps-item">
                            <div class="ps-label">üè† Rent Expected</div>
                            <div class="ps-value" id="ps-rent-expected">$0</div>
                        </div>
                        <div class="ps-item">
                            <div class="ps-label">üè† Rent Collected</div>
                            <div class="ps-value" id="ps-rent-collected">$0</div>
                        </div>
                        <div class="ps-item">
                            <div class="ps-label">üè¶ Mortgages Due</div>
                            <div class="ps-value" id="ps-mortgage-expected">$0</div>
                        </div>
                        <div class="ps-item">
                            <div class="ps-label">üè¶ Mortgages Paid</div>
                            <div class="ps-value" id="ps-mortgage-paid">$0</div>
                        </div>
                    </div>

                    <!-- Unpaid Section -->
                    <div class="payment-section-header">‚è≥ Unpaid / Outstanding</div>
                    <div id="payments-unpaid">
                        <div class="loading">Loading...</div>
                    </div>

                    <!-- Paid Section -->
                    <div class="payment-section-header" style="margin-top:30px;">‚úÖ Paid</div>
                    <div id="payments-paid">
                        <div class="loading">No payments yet this month</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Receipt Lightbox -->
    <div class="receipt-lightbox" id="receipt-lightbox" onclick="closeLightbox(event)">
        <img id="lb-image" src="" alt="Receipt">
        <div class="lb-nav">
            <button class="lb-prev" onclick="event.stopPropagation(); navigateLightbox(-1)">‚Üê Prev</button>
            <button class="lb-close" onclick="closeLightbox()">Close</button>
            <button class="lb-next" onclick="event.stopPropagation(); navigateLightbox(1)">Next ‚Üí</button>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://fzjzzujrjqjacbfbwcvd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6anp6dWpyanFqYWNiZmJ3Y3ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODg0NjYsImV4cCI6MjA4NTg2NDQ2Nn0.dwzx43oEMtLVha7WoLWqAkgRPMLzbE0NaOurS_JWyhY';
        
        // Wait for libraries to load and initialize
        let supabaseClient;
        
        function initSupabase() {
            try {
                // For UMD build, supabase is on window
                const { createClient } = window.supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase initialized successfully');
                return true;
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                return false;
            }
        }

        let allLeases = [];

        // Navigation
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(viewName).classList.add('active');
            // Find and activate the corresponding nav button
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(viewName.replace('-', ' '))) {
                    btn.classList.add('active');
                }
            });

            if (viewName === 'dashboard') loadDashboard();
            if (viewName === 'leases') loadAllLeases();
            if (viewName === 'expenses') { loadExpenseProperties(); loadExpenses(); }
            if (viewName === 'payments') { loadPaymentProperties(); loadPaymentDefaults(); loadMonthlyPayments(); }
        }

        // Reset form and show new lease view (not a renewal)
        function resetAndShowNewLease() {
            // Reset the form
            document.getElementById('lease-form').reset();
            
            // Reset renewal mode
            document.getElementById('is-renewal').value = 'false';
            document.getElementById('previous-lease-id').value = '';
            document.getElementById('renewal-indicator').style.display = 'none';
            document.getElementById('renewal-rent-section').style.display = 'none';
            document.getElementById('initial-rent-section').style.display = 'block';
            
            // Show the view
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('new-lease').classList.add('active');
            
            // Find and activate the New Lease button
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes('new lease')) {
                    btn.classList.add('active');
                }
            });
            
            // Reset tenant sections
            document.getElementById('tenant-count').value = '1';
            updateTenantSections();
            
            // Reload properties dropdown
            loadProperties();
        }

        // Show/hide tenant sections based on count
        function updateTenantSections() {
            const count = parseInt(document.getElementById('tenant-count').value);
            
            for (let i = 1; i <= 4; i++) {
                const section = document.getElementById(`tenant${i}-section`);
                const nameInput = document.getElementById(`tenant${i}_name`);
                
                if (i <= count) {
                    section.style.display = 'block';
                    if (i === 1) {
                        nameInput.required = true;
                    }
                } else {
                    section.style.display = 'none';
                    nameInput.required = false;
                    // Clear hidden fields
                    document.querySelector(`[name="tenant${i}_name"]`).value = '';
                    document.querySelector(`[name="tenant${i}_email"]`).value = '';
                    document.querySelector(`[name="tenant${i}_phone"]`).value = '';
                    document.querySelector(`[name="tenant${i}_employer"]`).value = '';
                }
            }
        }

        // Calculate end date and lease months
        function calculateEndDate() {
            const startDate = document.querySelector('[name="lease_start"]').value;
            const leaseType = document.querySelector('[name="lease_type"]').value;
            
            if (!startDate || !leaseType) return;

            const start = new Date(startDate);
            let end = new Date(start);
            let months = 0;

            switch(leaseType) {
                case 'month_to_month':
                    end.setMonth(end.getMonth() + 1);
                    months = 1;
                    break;
                case '12_month':
                    end.setFullYear(end.getFullYear() + 1);
                    months = 12;
                    break;
                case '24_month':
                    end.setFullYear(end.getFullYear() + 2);
                    months = 24;
                    break;
            }

            document.querySelector('[name="lease_end"]').value = end.toISOString().split('T')[0];
            document.querySelector('[name="lease_months"]').value = months;
        }

        // Calculate new rent for renewals based on % increase
        function calculateRenewalRent() {
            const previousRent = parseFloat(document.getElementById('previous-rent').value) || 0;
            const increasePercent = parseFloat(document.getElementById('rent-increase-percent').value) || 0;
            
            if (previousRent && increasePercent >= 0) {
                const newRent = previousRent * (1 + increasePercent / 100);
                document.getElementById('rent-amount-renewal').value = newRent.toFixed(2);
                document.getElementById('rent-amount-hidden').value = newRent.toFixed(2);
            }
        }

        // Calculate pet fees
        function calculatePetFees() {
            const numCats = parseInt(document.querySelector('[name="num_cats"]').value) || 0;
            const catFee = parseFloat(document.querySelector('[name="cat_fee"]').value) || 0;
            const numDogs = parseInt(document.querySelector('[name="num_dogs"]').value) || 0;
            const dogFee = parseFloat(document.querySelector('[name="dog_fee"]').value) || 0;

            // Just for display purposes - total pet fee
            const totalPetFee = (numCats * catFee) + (numDogs * dogFee);
            console.log('Total monthly pet fee:', totalPetFee);
        }

        // Initialize database
        async function initDatabase() {
            try {
                // Create leases table if it doesn't exist
                const { error } = await supabaseClient.rpc('create_leases_table');
                if (error && !error.message.includes('already exists')) {
                    console.error('Error creating table:', error);
                }
            } catch (e) {
                console.log('Database initialization note:', e.message);
            }
        }

        // Form submission
        document.getElementById('lease-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Copy the correct rent_amount to the hidden field
            const isRenewal = document.getElementById('is-renewal').value === 'true';
            if (isRenewal) {
                // For renewals, value is already set by calculateRenewalRent
                const renewalRent = document.getElementById('rent-amount-renewal').value;
                if (!renewalRent) {
                    showAlert('Please enter a rent increase percentage', 'error');
                    return;
                }
            } else {
                // For initial leases, copy from initial rent field
                const initialRent = document.getElementById('rent-amount-initial').value;
                if (!initialRent) {
                    showAlert('Please enter a rent amount', 'error');
                    return;
                }
                document.getElementById('rent-amount-hidden').value = initialRent;
            }
            
            const formData = new FormData(e.target);
            const leaseData = {};
            
            // Collect all form data
            for (let [key, value] of formData.entries()) {
                leaseData[key] = value;
            }
            
            // Store renewal info for later use in PDF generation, but remove from database save
            const renewalInfo = {
                isRenewal: leaseData.is_renewal === 'true',
                previousLeaseId: leaseData.previous_lease_id
            };
            delete leaseData.is_renewal;
            delete leaseData.previous_lease_id;
            
            // Build tenant names string for display
            const tenantNames = [];
            if (leaseData.tenant1_name) tenantNames.push(leaseData.tenant1_name);
            if (leaseData.tenant2_name) tenantNames.push(leaseData.tenant2_name);
            if (leaseData.tenant3_name) tenantNames.push(leaseData.tenant3_name);
            if (leaseData.tenant4_name) tenantNames.push(leaseData.tenant4_name);
            leaseData.tenant_names = tenantNames.join(', ');
            
            // Add calculated fields
            leaseData.status = 'active';
            leaseData.created_at = new Date().toISOString();
            leaseData.base_rent = leaseData.rent_amount; // For initial leases, base_rent = rent_amount
            
            try {
                // Save to database
                const { data, error } = await supabaseClient
                    .from('leases')
                    .insert([leaseData])
                    .select();

                if (error) throw error;

                showAlert('Lease saved successfully!', 'success');
                
                // If this is a renewal, terminate the old lease
                if (renewalInfo.isRenewal && renewalInfo.previousLeaseId) {
                    try {
                        await supabaseClient
                            .from('leases')
                            .update({ status: 'terminated' })
                            .eq('id', renewalInfo.previousLeaseId);
                    } catch (terminateError) {
                        console.error('Error terminating old lease:', terminateError);
                        // Don't fail the whole process if old lease termination fails
                    }
                }
                
                // Add renewal info back to leaseData for PDF generation
                leaseData.is_renewal = renewalInfo.isRenewal ? 'true' : 'false';
                leaseData.previous_lease_id = renewalInfo.previousLeaseId;
                
                // Generate PDF
                generatePDF(leaseData);
                
                // Reset form after 2 seconds
                setTimeout(() => {
                    e.target.reset();
                    // Reset renewal mode
                    document.getElementById('is-renewal').value = 'false';
                    document.getElementById('previous-lease-id').value = '';
                    document.getElementById('renewal-indicator').style.display = 'none';
                    document.getElementById('renewal-rent-section').style.display = 'none';
                    document.getElementById('initial-rent-section').style.display = 'block';
                    showView('dashboard');
                }, 2000);

            } catch (error) {
                console.error('Error saving lease:', error);
                showAlert('Error saving lease: ' + error.message, 'error');
            }
        });

        // Generate PDF
        // Generate PDF matching the exact format of the lease page 1
        function generatePDF(leaseData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Use Times Roman font (default)
            doc.setFont('times', 'normal');
            
            let y = 20;
            const leftMargin = 20;
            
            // Title
            doc.setFontSize(14);
            doc.setFont('times', 'bold');
            doc.text('1 - RESIDENTIAL LEASE AGREEMENT', leftMargin, y);
            
            y += 10;
            
            // Renewal indicator if applicable
            if (leaseData.is_renewal === 'true' && leaseData.previous_lease_id) {
                doc.setFontSize(10);
                doc.setFont('times', 'bold');
                doc.text('‚òë', leftMargin, y);
                doc.text('LEASE RENEWAL', leftMargin + 5, y);
                y += 5;
                doc.setFont('times', 'normal');
                doc.setFontSize(9);
                // Note: We don't have the previous lease date in leaseData, so we'll just indicate it's a renewal
                doc.text('This lease renews and replaces the previous lease agreement for this property.', leftMargin + 5, y);
                y += 8;
            }
            
            doc.setFontSize(11);
            doc.setFont('times', 'bold');
            doc.text('1.1 TERMS AND PARTIES', leftMargin, y);
            
            y += 6;
            doc.setFontSize(10);
            doc.setFont('times', 'normal');
            
            // Build the first paragraph with filled in data
            const leaseMonths = leaseData.lease_months || '';
            const leaseStart = leaseData.lease_start || '________';
            const leaseEnd = leaseData.lease_end || '________';
            
            const para1 = `This is a lease for a period of ${leaseMonths} months (the "Lease Term") beginning on ${leaseStart} and ending on ${leaseEnd}.`;
            const splitPara1 = doc.splitTextToSize(para1, 170);
            doc.text(splitPara1, leftMargin, y);
            y += splitPara1.length * 5;
            
            y += 2;
            const para2 = `Between Colette Fritzlen, ("Landlord") and ${leaseData.tenant_names || '________'} ("Tenants").`;
            const splitPara2 = doc.splitTextToSize(para2, 170);
            doc.text(splitPara2, leftMargin, y);
            y += splitPara2.length * 5;
            
            // Tenant information
            y += 3;
            const tenantCount = parseInt(leaseData.tenant_count) || 1;
            
            for (let i = 1; i <= tenantCount; i++) {
                const email = leaseData[`tenant${i}_email`] || '___________________________';
                const phone = leaseData[`tenant${i}_phone`] || '_____________________';
                const employer = leaseData[`tenant${i}_employer`] || '_____________________________________________';
                
                const tenantInfo = `Tenant's Email Address: ${email}  Tenant Telephone Number: ${phone}  Tenant's Employer: ${employer}`;
                const splitTenant = doc.splitTextToSize(tenantInfo, 170);
                doc.text(splitTenant, leftMargin, y);
                y += splitTenant.length * 5;
            }
            
            y += 2;
            const landlordInfo = `Landlord's Email Address: mocopropert908@gmail.com  Landlord's Telephone Number: 570-560-6626`;
            const splitLandlord = doc.splitTextToSize(landlordInfo, 170);
            doc.text(splitLandlord, leftMargin, y);
            y += splitLandlord.length * 5;
            
            y += 8;
            doc.setFont('times', 'bold');
            doc.text('1.2 PROPERTY RENTED', leftMargin, y);
            
            y += 6;
            doc.setFont('times', 'normal');
            doc.text('Landlord leases to Tenant property located at:', leftMargin, y);
            
            y += 5;
            doc.setFont('times', 'bold');
            const splitAddress = doc.splitTextToSize(leaseData.property_address || '________', 170);
            doc.text(splitAddress, leftMargin + 5, y);
            doc.setFont('times', 'normal');
            y += splitAddress.length * 5;
            
            y += 6;
            doc.text('Together with the following furniture and appliances, if any:', leftMargin, y);
            
            y += 5;
            // Appliance checkboxes
            doc.rect(leftMargin + 5, y - 3, 3, 3);
            doc.text('Refrigerator', leftMargin + 10, y);
            doc.rect(leftMargin + 45, y - 3, 3, 3);
            doc.text('Range', leftMargin + 50, y);
            doc.rect(leftMargin + 75, y - 3, 3, 3);
            doc.text('Dishwasher', leftMargin + 80, y);
            doc.rect(leftMargin + 115, y - 3, 3, 3);
            doc.text('Microwave', leftMargin + 120, y);
            doc.rect(leftMargin + 155, y - 3, 3, 3);
            doc.text('Washer/dryer', leftMargin + 160, y);
            
            y += 8;
            doc.text('The Premises shall be occupied only by the Tenant(s) and the following persons:', leftMargin, y);
            y += 5;
            doc.text('_______________________________________________________________________________________', leftMargin, y);
            
            y += 8;
            doc.setFont('times', 'bold');
            doc.text('1.3 COMMON AREAS', leftMargin, y);
            
            y += 6;
            doc.setFont('times', 'normal');
            doc.text('Under no circumstances are common areas to be used for tenant storage.', leftMargin, y);
            
            y += 8;
            doc.setFont('times', 'bold');
            doc.text('1.4 RENT PAYMENTS AND CHARGES', leftMargin, y);
            
            y += 6;
            doc.setFont('times', 'normal');
            const rentAmount = leaseData.rent_amount || '________';
            doc.text(`Tenant Shall pay rent for the Premises in installments of RENT $${rentAmount}`, leftMargin, y);
            
            y += 6;
            const rentText = `Tenant shall pay the rent and all other charges required to be paid under the Lease by submitting payment online or utilizing a 3rd party electronic payment service. Landlord reserves the right to accept or reject payments utilizing other methods including check or money order. No personal checks will be accepted after the fifth day of each month.`;
            const splitRentText = doc.splitTextToSize(rentText, 170);
            doc.text(splitRentText, leftMargin, y);
            y += splitRentText.length * 5;
            
            y += 3;
            const proRataText = `The landlord may appoint an agent to collect the Lease Payment and to perform the Landlord's obligations. If the tenancy starts on a day other than the first day of the month, Tenant shall pay pro-rated rent until the first regular rental payment date.`;
            const splitProRata = doc.splitTextToSize(proRataText, 170);
            doc.text(splitProRata, leftMargin, y);
            y += splitProRata.length * 5;
            
            y += 8;
            doc.setFont('times', 'bold');
            doc.text('1.5 SECURITY DEPOSIT AND ADVANCE RENT', leftMargin, y);
            
            y += 6;
            doc.setFont('times', 'normal');
            const splitDeposit = doc.splitTextToSize('In addition to the Lease Payments described above, Tenant shall pay the following: (check all that apply)', 170);
            doc.text(splitDeposit, leftMargin, y);
            y += splitDeposit.length * 5;
            
            y += 3;
            const firstMonth = leaseData.first_month_rent || '';
            const lastMonth = leaseData.last_month_rent || '';
            const securityDep = leaseData.security_deposit || '';
            
            // First month checkbox
            if (firstMonth) doc.text('‚òë', leftMargin, y);
            else doc.rect(leftMargin, y - 3, 3, 3);
            doc.text(`First month's Rent of $${firstMonth || '________'} due at lease signing.`, leftMargin + 5, y);
            y += 5;
            
            // Last month checkbox
            if (lastMonth) doc.text('‚òë', leftMargin, y);
            else doc.rect(leftMargin, y - 3, 3, 3);
            doc.text(`Last month's Rent of $${lastMonth || '________'} due at lease signing.`, leftMargin + 5, y);
            y += 5;
            
            // Security deposit checkbox
            if (securityDep) doc.text('‚òë', leftMargin, y);
            else doc.rect(leftMargin, y - 3, 3, 3);
            doc.text(`Security Deposit of $${securityDep || '________'} due at lease signing.`, leftMargin + 5, y);
            y += 6;
            
            doc.text('A monthly non-refundable pet fee (if applicable) in the amount of', leftMargin, y);
            y += 5;
            const catFee = leaseData.cat_fee || '';
            const numCats = leaseData.num_cats || '';
            const catTotal = (catFee && numCats) ? (parseFloat(catFee) * parseInt(numCats)).toFixed(2) : '';
            const catLine = `$${catFee || '________'}/month per cat ‚Äì number of cats ${numCats || '___'} - Total Monthly Fee to be paid with rent $${catTotal || '________'}`;
            const splitCat = doc.splitTextToSize(catLine, 165);
            doc.text(splitCat, leftMargin + 5, y);
            y += splitCat.length * 5;
            
            const dogFee = leaseData.dog_fee || '';
            const numDogs = leaseData.num_dogs || '';
            const dogTotal = (dogFee && numDogs) ? (parseFloat(dogFee) * parseInt(numDogs)).toFixed(2) : '';
            const dogLine = `$${dogFee || '________'}/month per dog ‚Äì number of dogs ${numDogs || '___'} - Total Monthly Fee to be paid with rent $${dogTotal || '________'}`;
            const splitDog = doc.splitTextToSize(dogLine, 165);
            doc.text(splitDog, leftMargin + 5, y);
            
            // Add new page for signatures (Page 19)
            doc.addPage();
            y = 20;
            
            // Section 9 - Sign and Accept
            doc.setFontSize(14);
            doc.setFont('times', 'bold');
            doc.text('9. Sign and Accept', leftMargin, y);
            
            y += 10;
            doc.setFontSize(11);
            doc.text('9.1 SIGN BELOW', leftMargin, y);
            
            y += 8;
            doc.setFontSize(10);
            doc.setFont('times', 'normal');
            doc.text('The Lease has been executed by the parties on the dates indicated below.', leftMargin, y);
            
            y += 15;
            
            // Tenant signatures (tenantCount already declared earlier in this function)
            
            for (let i = 1; i <= tenantCount; i++) {
                const tenantName = leaseData[`tenant${i}_name`] || `Tenant ${i}`;
                
                // X mark
                doc.setFontSize(16);
                doc.text('X', leftMargin, y);
                
                // Signature line
                doc.setFontSize(10);
                doc.line(leftMargin + 10, y, leftMargin + 90, y);
                
                y += 6;
                
                // Name and role
                doc.setFont('times', 'normal');
                doc.text(`${tenantName} - Lessee`, leftMargin + 10, y);
                
                y += 20;
            }
            
            y += 10;
            
            // Landlord signature
            doc.setFontSize(16);
            doc.text('X', leftMargin, y);
            
            // Signature line
            doc.setFontSize(10);
            doc.line(leftMargin + 10, y, leftMargin + 90, y);
            
            y += 6;
            
            // Name and role
            doc.setFont('times', 'normal');
            doc.text('Colette Fritzlen', leftMargin + 10, y);
            y += 5;
            doc.text('Lessor', leftMargin + 10, y);
            
            // Save PDF
            const filename = `Lease_Pages1-19_${leaseData.tenant_names ? leaseData.tenant_names.replace(/\s+/g, '_') : 'Draft'}_${leaseData.lease_start || 'Draft'}.pdf`;
            doc.save(filename);
        }

        // Load properties into dropdown
        async function loadProperties() {
            try {
                const { data: properties, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .eq('is_building_level', false)  // Only load units, not buildings
                    .eq('status', 'active')
                    .order('property_name', { ascending: true });

                if (error) throw error;

                const dropdown = document.getElementById('property-dropdown');
                dropdown.innerHTML = '<option value="">Select Property</option>';
                
                properties.forEach(prop => {
                    const option = document.createElement('option');
                    option.value = prop.property_name;
                    option.textContent = prop.property_name;
                    dropdown.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading properties:', error);
                const dropdown = document.getElementById('property-dropdown');
                dropdown.innerHTML = '<option value="">Error loading properties</option>';
            }
        }

        // Load dashboard
        async function loadDashboard() {
            try {
                const { data: leases, error } = await supabaseClient
                    .from('leases')
                    .select('*')
                    .order('lease_start', { ascending: false });

                if (error) throw error;

                // Calculate stats
                const today = new Date();
                const activeLeases = leases.filter(l => {
                    const endDate = new Date(l.lease_end);
                    return l.status === 'active' && endDate >= today;
                });
                const uniqueProperties = new Set(leases.map(l => l.property_address)).size;
                
                // Calculate expiring soon (30 days)
                const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
                const expiringSoon = activeLeases.filter(l => {
                    const endDate = new Date(l.lease_end);
                    return endDate >= today && endDate <= thirtyDaysFromNow;
                });

                // Calculate total revenue
                // Get most recent lease per property (excluding terminated)
                const revenueLeases = [];
                const propertiesMap = new Map();
                
                // Get non-terminated leases grouped by property
                const nonTerminatedLeases = leases.filter(l => l.status !== 'terminated');
                
                // For each property, get the most recent lease
                nonTerminatedLeases.forEach(lease => {
                    const existing = propertiesMap.get(lease.property_address);
                    if (!existing || new Date(lease.created_at) > new Date(existing.created_at)) {
                        propertiesMap.set(lease.property_address, lease);
                    }
                });
                
                // Convert map to array and calculate revenue
                const totalRevenue = Array.from(propertiesMap.values())
                    .reduce((sum, l) => sum + parseFloat(l.rent_amount || 0), 0);

                // Update stats
                document.getElementById('stat-properties').textContent = uniqueProperties;
                document.getElementById('stat-active').textContent = activeLeases.length;
                document.getElementById('stat-expiring').textContent = expiringSoon.length;
                document.getElementById('stat-revenue').textContent = `$${totalRevenue.toLocaleString()}`;

                // Show upcoming renewals
                const renewalsHtml = expiringSoon.length > 0 
                    ? expiringSoon.map(lease => `
                        <div style="padding: 12px; border-left: 3px solid #f59e0b; background: #fffbeb; margin-bottom: 8px; border-radius: 4px;">
                            <strong>${lease.tenant_names}</strong> - ${lease.property_address}<br>
                            <small style="color: #92400e;">Expires: ${lease.lease_end}</small>
                        </div>
                    `).join('')
                    : '<p style="color: #64748b;">No leases expiring in the next 30 days.</p>';

                document.getElementById('renewals-container').innerHTML = renewalsHtml;

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load all leases
        async function loadAllLeases() {
            try {
                const { data: leases, error } = await supabaseClient
                    .from('leases')
                    .select('*')
                    .order('lease_start', { ascending: false });

                if (error) throw error;

                allLeases = leases;
                displayLeases(leases);

            } catch (error) {
                console.error('Error loading leases:', error);
                document.getElementById('leases-tbody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; color: #ef4444;">Error loading leases</td></tr>';
            }
        }

        // Display leases in table
        function displayLeases(leases) {
            const tbody = document.getElementById('leases-tbody');
            
            if (leases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No leases found</td></tr>';
                return;
            }

            const today = new Date();
            
            tbody.innerHTML = leases.map(lease => {
                const endDate = new Date(lease.lease_end);
                const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass = 'status-active';
                let statusText = 'Active';
                
                if (lease.status === 'terminated') {
                    statusClass = 'status-expired';
                    statusText = 'Terminated';
                } else if (daysUntilEnd < 0) {
                    statusClass = 'status-expired';
                    statusText = 'Expired';
                } else if (daysUntilEnd <= 30) {
                    statusClass = 'status-expiring';
                    statusText = 'Expiring Soon';
                }

                return `
                    <tr>
                        <td>${lease.tenant_names}</td>
                        <td>${lease.property_address}</td>
                        <td>${lease.lease_start}</td>
                        <td>${lease.lease_end}</td>
                        <td>$${parseFloat(lease.rent_amount).toLocaleString()}</td>
                        <td>${lease.lease_type.replace('_', ' ')}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn btn-primary" onclick="viewLease(${lease.id})">View</button>
                            <button class="action-btn btn-secondary" onclick="regeneratePDF(${lease.id})">PDF</button>
                            ${lease.status === 'active' ? `<button class="action-btn" style="background: #10b981; color: white;" onclick="renewLease(${lease.id})">Renew</button>` : ''}
                            ${lease.status === 'active' ? `<button class="action-btn" style="background: #ef4444; color: white;" onclick="endLease(${lease.id})">End</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter leases
        function filterLeases(searchTerm) {
            const filtered = allLeases.filter(lease => 
                lease.tenant_names.toLowerCase().includes(searchTerm.toLowerCase()) ||
                lease.property_address.toLowerCase().includes(searchTerm.toLowerCase())
            );
            displayLeases(filtered);
        }

        // View lease details
        function viewLease(id) {
            const lease = allLeases.find(l => l.id === id);
            if (lease) {
                alert(`Lease Details:\n\nTenant: ${lease.tenant_names}\nProperty: ${lease.property_address}\nRent: $${lease.rent_amount}\nStart: ${lease.lease_start}\nEnd: ${lease.lease_end}`);
            }
        }

        // Regenerate PDF
        function regeneratePDF(id) {
            const lease = allLeases.find(l => l.id === id);
            if (lease) {
                generatePDF(lease);
            }
        }

        // End a lease
        async function endLease(id) {
            if (!confirm('Are you sure you want to end this lease? This will mark it as terminated.')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('leases')
                    .update({ status: 'terminated' })
                    .eq('id', id);

                if (error) throw error;

                showAlert('Lease ended successfully', 'success');
                loadDashboard();
                loadAllLeases();
            } catch (error) {
                console.error('Error ending lease:', error);
                showAlert('Error ending lease: ' + error.message, 'error');
            }
        }

        // Renew a lease - pre-fills form with existing data
        function renewLease(id) {
            const lease = allLeases.find(l => l.id === id);
            if (!lease) return;

            // Switch to New Lease tab
            showView('new-lease');
            
            // Mark as renewal
            document.getElementById('is-renewal').value = 'true';
            document.getElementById('previous-lease-id').value = id;
            
            // Show renewal indicator
            document.getElementById('renewal-indicator').style.display = 'block';
            document.getElementById('renewal-rent-section').style.display = 'block';
            document.getElementById('initial-rent-section').style.display = 'none';
            
            // Set tenant count
            const tenantCount = parseInt(lease.tenant_count) || 1;
            document.getElementById('tenant-count').value = tenantCount;
            updateTenantSections();
            
            // Fill tenant info
            for (let i = 1; i <= tenantCount; i++) {
                if (lease[`tenant${i}_name`]) {
                    document.querySelector(`[name="tenant${i}_name"]`).value = lease[`tenant${i}_name`] || '';
                    document.querySelector(`[name="tenant${i}_email"]`).value = lease[`tenant${i}_email`] || '';
                    document.querySelector(`[name="tenant${i}_phone"]`).value = lease[`tenant${i}_phone`] || '';
                    document.querySelector(`[name="tenant${i}_employer"]`).value = lease[`tenant${i}_employer`] || '';
                }
            }
            
            // Fill property
            document.querySelector('[name="property_address"]').value = lease.property_address;
            
            // Set previous rent and prepare for increase
            document.getElementById('previous-rent').value = lease.rent_amount;
            document.getElementById('rent-increase-percent').value = '';
            document.getElementById('rent-amount').value = '';
            
            // Fill deposits (can be edited)
            document.querySelector('[name="security_deposit"]').value = lease.security_deposit || '';
            document.querySelector('[name="first_month_rent"]').value = lease.first_month_rent || '';
            document.querySelector('[name="last_month_rent"]').value = lease.last_month_rent || '';
            
            // Fill pet info (defaults from old lease, can be edited)
            document.querySelector('[name="num_cats"]').value = lease.num_cats || 0;
            document.querySelector('[name="cat_fee"]').value = lease.cat_fee || 0;
            document.querySelector('[name="num_dogs"]').value = lease.num_dogs || 0;
            document.querySelector('[name="dog_fee"]').value = lease.dog_fee || 0;
            
            // Fill notes
            document.querySelector('[name="notes"]').value = lease.notes || '';
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            showAlert('Renewing lease - update dates and rent increase %', 'success');
        }

        // Show alerts
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // ============ EXPENSES ============

        let allExpenses = [];
        let pendingReceiptFiles = [];
        let existingReceiptUrls = [];

        // Drag and drop setup (called after DOM loads)
        function initDragDrop() {
            const dropArea = document.getElementById('receipt-drop-area');
            if (!dropArea) return;

            ['dragenter', 'dragover'].forEach(evt => {
                dropArea.addEventListener(evt, e => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropArea.classList.add('drag-over');
                });
            });

            ['dragleave', 'drop'].forEach(evt => {
                dropArea.addEventListener(evt, e => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropArea.classList.remove('drag-over');
                });
            });

            dropArea.addEventListener('drop', e => {
                const files = e.dataTransfer.files;
                if (files.length) handleReceiptFiles(files);
            });
        }

        // Load ALL properties (buildings + units) into expense dropdowns
        async function loadExpenseProperties() {
            try {
                const { data: properties, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .eq('status', 'active')
                    .order('property_name', { ascending: true });

                if (error) throw error;

                ['expense-property', 'filter-property'].forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    const firstOption = dropdown.options[0].textContent;
                    dropdown.innerHTML = `<option value="">${firstOption}</option>`;
                    
                    const buildings = properties.filter(p => p.is_building_level);
                    const units = properties.filter(p => !p.is_building_level);

                    if (buildings.length) {
                        const group1 = document.createElement('optgroup');
                        group1.label = 'üè¢ Buildings';
                        buildings.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.property_name;
                            opt.textContent = p.property_name;
                            group1.appendChild(opt);
                        });
                        dropdown.appendChild(group1);
                    }

                    if (units.length) {
                        const group2 = document.createElement('optgroup');
                        group2.label = 'üè† Units';
                        units.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.property_name;
                            opt.textContent = p.property_name;
                            group2.appendChild(opt);
                        });
                        dropdown.appendChild(group2);
                    }
                });
            } catch (error) {
                console.error('Error loading expense properties:', error);
            }
        }

        function toggleExpenseForm() {
            const container = document.getElementById('expense-form-container');
            container.classList.toggle('visible');
            if (container.classList.contains('visible')) {
                if (!document.getElementById('expense-date').value) {
                    document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                }
                initDragDrop();
            }
        }

        function cancelExpenseEdit() {
            document.getElementById('expense-form').reset();
            document.getElementById('expense-id').value = '';
            document.getElementById('expense-save-btn').textContent = 'Save Expense';
            document.getElementById('expense-form-container').classList.remove('visible');
            pendingReceiptFiles = [];
            existingReceiptUrls = [];
            renderReceiptThumbnails();
        }

        // Handle receipt file selection ‚Äî images AND PDFs
        function handleReceiptFiles(files) {
            const totalCount = pendingReceiptFiles.length + existingReceiptUrls.length;
            const remaining = 3 - totalCount;
            
            if (remaining <= 0) {
                showExpenseAlert('Maximum 3 receipts per expense', 'error');
                return;
            }

            for (let i = 0; i < Math.min(files.length, remaining); i++) {
                const file = files[i];
                const isImage = file.type.startsWith('image/');
                const isPdf = file.type === 'application/pdf';
                // iPhone sometimes has empty type for HEIC ‚Äî check extension too
                const ext = file.name.split('.').pop().toLowerCase();
                const isImageExt = ['jpg','jpeg','png','gif','webp','heic','heif','bmp','tiff'].includes(ext);
                const isPdfExt = ext === 'pdf';
                if (!isImage && !isPdf && !isImageExt && !isPdfExt) {
                    showExpenseAlert('Only images and PDFs are allowed', 'error');
                    continue;
                }
                if (file.size > 10 * 1024 * 1024) {
                    showExpenseAlert('File too large (max 10MB): ' + file.name, 'error');
                    continue;
                }
                pendingReceiptFiles.push(file);
            }

            document.getElementById('receipt-input').value = '';
            renderReceiptThumbnails();
        }

        // Helper: check if URL is a PDF
        function isPdfUrl(url) {
            const lower = url.toLowerCase();
            return lower.includes('.pdf') || lower.includes('application/pdf');
        }

        // Render thumbnail previews in form
        function renderReceiptThumbnails() {
            const container = document.getElementById('receipt-thumbnails');
            container.innerHTML = '';

            existingReceiptUrls.forEach((url, i) => {
                const thumb = document.createElement('div');
                thumb.className = 'receipt-thumb';
                if (isPdfUrl(url)) {
                    thumb.innerHTML = `
                        <div class="pdf-icon" onclick="window.open('${url}', '_blank')">PDF</div>
                        <button class="remove-receipt" onclick="removeExistingReceipt(${i})" title="Remove">√ó</button>
                    `;
                } else {
                    thumb.innerHTML = `
                        <img src="${url}" onclick="openLightbox(existingReceiptUrls, ${i})" alt="Receipt">
                        <button class="remove-receipt" onclick="removeExistingReceipt(${i})" title="Remove">√ó</button>
                    `;
                }
                container.appendChild(thumb);
            });

            pendingReceiptFiles.forEach((file, i) => {
                const thumb = document.createElement('div');
                thumb.className = 'receipt-thumb';
                const ext = file.name.split('.').pop().toLowerCase();
                if (file.type === 'application/pdf' || ext === 'pdf') {
                    thumb.innerHTML = `
                        <div class="pdf-icon">PDF</div>
                        <button class="remove-receipt" onclick="removePendingReceipt(${i})" title="Remove">√ó</button>
                    `;
                } else {
                    const url = URL.createObjectURL(file);
                    thumb.innerHTML = `
                        <img src="${url}" alt="Receipt" onerror="this.style.display='none';this.parentElement.insertAdjacentHTML('afterbegin','<div class=\\'pdf-icon\\' style=\\'background:#e0e7ff;color:#3730a3\\'>IMG</div>')">
                        <button class="remove-receipt" onclick="removePendingReceipt(${i})" title="Remove">√ó</button>
                    `;
                }
                container.appendChild(thumb);
            });
        }

        function removePendingReceipt(index) {
            pendingReceiptFiles.splice(index, 1);
            renderReceiptThumbnails();
        }

        function removeExistingReceipt(index) {
            const url = existingReceiptUrls[index];
            existingReceiptUrls.splice(index, 1);
            renderReceiptThumbnails();
            try {
                const path = url.split('/receipts/')[1];
                if (path) supabaseClient.storage.from('receipts').remove([decodeURIComponent(path)]);
            } catch(e) { console.warn('Could not delete file from storage', e); }
        }

        async function uploadReceipt(file) {
            const timestamp = Date.now();
            const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
            const filePath = `${timestamp}_${safeName}`;

            const { data, error } = await supabaseClient.storage
                .from('receipts')
                .upload(filePath, file, { cacheControl: '3600', upsert: false });

            if (error) throw error;

            const { data: urlData } = supabaseClient.storage
                .from('receipts')
                .getPublicUrl(filePath);

            return urlData.publicUrl;
        }

        // Save expense with new fields
        async function saveExpense(event) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('expense-save-btn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = originalText + '<span class="uploading-spinner"></span>';

            const expenseId = document.getElementById('expense-id').value;

            try {
                const newUrls = [];
                for (const file of pendingReceiptFiles) {
                    const url = await uploadReceipt(file);
                    newUrls.push(url);
                }

                const allReceiptUrls = [...existingReceiptUrls, ...newUrls];

                const expenseData = {
                    expense_date: document.getElementById('expense-date').value,
                    property_name: document.getElementById('expense-property').value,
                    category: document.getElementById('expense-category').value,
                    amount: parseFloat(document.getElementById('expense-amount').value),
                    vendor: document.getElementById('expense-vendor').value || null,
                    martin_hours: parseFloat(document.getElementById('expense-martin-hours').value) || null,
                    colette_hours: parseFloat(document.getElementById('expense-colette-hours').value) || null,
                    miles: parseFloat(document.getElementById('expense-miles').value) || null,
                    notes: document.getElementById('expense-notes').value || null,
                    receipt_urls: allReceiptUrls.length ? allReceiptUrls : null
                };

                if (expenseId) {
                    const { error } = await supabaseClient
                        .from('expenses')
                        .update(expenseData)
                        .eq('id', expenseId);
                    if (error) throw error;
                    showExpenseAlert('Expense updated!', 'success');
                } else {
                    const { error } = await supabaseClient
                        .from('expenses')
                        .insert([expenseData]);
                    if (error) throw error;
                    showExpenseAlert('Expense saved!', 'success');
                }

                cancelExpenseEdit();
                loadExpenses();
            } catch (error) {
                console.error('Error saving expense:', error);
                showExpenseAlert('Error saving expense: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function loadExpenses() {
            try {
                let query = supabaseClient
                    .from('expenses')
                    .select('*')
                    .order('expense_date', { ascending: false });

                const filterProperty = document.getElementById('filter-property').value;
                const filterCategory = document.getElementById('filter-category').value;
                const filterFrom = document.getElementById('filter-date-from').value;
                const filterTo = document.getElementById('filter-date-to').value;

                if (filterProperty) query = query.eq('property_name', filterProperty);
                if (filterCategory) query = query.eq('category', filterCategory);
                if (filterFrom) query = query.gte('expense_date', filterFrom);
                if (filterTo) query = query.lte('expense_date', filterTo);

                const { data: expenses, error } = await query;
                if (error) throw error;

                allExpenses = expenses || [];
                renderExpenses(allExpenses);
            } catch (error) {
                console.error('Error loading expenses:', error);
                document.getElementById('expenses-tbody').innerHTML = 
                    '<tr><td colspan="10" class="loading">Error loading expenses</td></tr>';
            }
        }

        function renderExpenses(expenses) {
            const tbody = document.getElementById('expenses-tbody');
            
            if (!expenses.length) {
                tbody.innerHTML = '<tr><td colspan="10" class="loading">No expenses found</td></tr>';
                document.getElementById('expense-total').textContent = '$0.00';
                document.getElementById('expense-count').textContent = '0';
                return;
            }

            const total = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            document.getElementById('expense-total').textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('expense-count').textContent = expenses.length;

            tbody.innerHTML = expenses.map(e => {
                const receipts = e.receipt_urls || [];
                const receiptCell = receipts.length 
                    ? `<button class="receipt-badge" onclick='viewReceipts(${e.id})'>üìé ${receipts.length}</button>`
                    : '<span style="color:#94a3b8;">‚Äî</span>';

                const fmtHrs = (v) => v ? v : '‚Äî';

                return `
                <tr>
                    <td>${formatDate(e.expense_date)}</td>
                    <td>${e.property_name || ''}</td>
                    <td><span class="status-badge" style="background:#e0e7ff;color:#3730a3;">${e.category}</span></td>
                    <td><strong>$${parseFloat(e.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                    <td>${e.vendor || '‚Äî'}</td>
                    <td>${fmtHrs(e.martin_hours)}</td>
                    <td>${fmtHrs(e.colette_hours)}</td>
                    <td>${e.miles || '‚Äî'}</td>
                    <td>${receiptCell}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="copyExpense(${e.id})" title="Duplicate">üìã</button>
                        <button class="action-btn edit-btn" onclick="editExpense(${e.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteExpense(${e.id})">Delete</button>
                    </td>
                </tr>`;
            }).join('');
        }

        // View receipts ‚Äî handles both images (lightbox) and PDFs (new tab)
        function viewReceipts(id) {
            const expense = allExpenses.find(e => e.id === id);
            if (!expense || !expense.receipt_urls) return;

            const urls = expense.receipt_urls;
            const imageUrls = urls.filter(u => !isPdfUrl(u));
            const pdfUrls = urls.filter(u => isPdfUrl(u));

            // Open PDFs in new tabs
            pdfUrls.forEach(url => window.open(url, '_blank'));

            // Open images in lightbox
            if (imageUrls.length) {
                openLightbox(imageUrls, 0);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function editExpense(id) {
            const expense = allExpenses.find(e => e.id === id);
            if (!expense) return;

            document.getElementById('expense-id').value = expense.id;
            document.getElementById('expense-date').value = expense.expense_date;
            document.getElementById('expense-property').value = expense.property_name;
            document.getElementById('expense-category').value = expense.category;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-vendor').value = expense.vendor || '';
            document.getElementById('expense-martin-hours').value = expense.martin_hours || '';
            document.getElementById('expense-colette-hours').value = expense.colette_hours || '';
            document.getElementById('expense-miles').value = expense.miles || '';
            document.getElementById('expense-notes').value = expense.notes || '';
            document.getElementById('expense-save-btn').textContent = 'Update Expense';
            
            pendingReceiptFiles = [];
            existingReceiptUrls = expense.receipt_urls ? [...expense.receipt_urls] : [];
            renderReceiptThumbnails();

            document.getElementById('expense-form-container').classList.add('visible');
            initDragDrop();
            window.scrollTo(0, 0);
        }

        // Copy/duplicate an expense ‚Äî pre-fills form with same data, today's date, no ID
        function copyExpense(id) {
            const expense = allExpenses.find(e => e.id === id);
            if (!expense) return;

            // Clear ID so it saves as new
            document.getElementById('expense-id').value = '';
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('expense-property').value = expense.property_name;
            document.getElementById('expense-category').value = expense.category;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-vendor').value = expense.vendor || '';
            document.getElementById('expense-martin-hours').value = expense.martin_hours || '';
            document.getElementById('expense-colette-hours').value = expense.colette_hours || '';
            document.getElementById('expense-miles').value = expense.miles || '';
            document.getElementById('expense-notes').value = expense.notes || '';
            document.getElementById('expense-save-btn').textContent = 'Save Expense';

            // Copy receipt references so they can be reused
            pendingReceiptFiles = [];
            existingReceiptUrls = expense.receipt_urls ? [...expense.receipt_urls] : [];
            renderReceiptThumbnails();

            document.getElementById('expense-form-container').classList.add('visible');
            initDragDrop();
            window.scrollTo(0, 0);
            showExpenseAlert('Copied! Change the date and hit Save.', 'success');
        }

        async function deleteExpense(id) {
            if (!confirm('Delete this expense?')) return;

            try {
                const expense = allExpenses.find(e => e.id === id);
                
                const { error } = await supabaseClient
                    .from('expenses')
                    .delete()
                    .eq('id', id);
                if (error) throw error;

                if (expense && expense.receipt_urls && expense.receipt_urls.length) {
                    const paths = expense.receipt_urls.map(url => {
                        const parts = url.split('/receipts/');
                        return parts[1] ? decodeURIComponent(parts[1]) : null;
                    }).filter(Boolean);
                    if (paths.length) {
                        await supabaseClient.storage.from('receipts').remove(paths);
                    }
                }

                showExpenseAlert('Expense deleted', 'success');
                loadExpenses();
            } catch (error) {
                console.error('Error deleting expense:', error);
                showExpenseAlert('Error deleting: ' + error.message, 'error');
            }
        }

        // ---- Lightbox ----
        let lightboxUrls = [];
        let lightboxIndex = 0;

        function openLightbox(urls, index) {
            // Filter out PDFs ‚Äî those open in new tab
            const imageOnly = urls.filter(u => !isPdfUrl(u));
            if (!imageOnly.length) return;
            lightboxUrls = imageOnly;
            lightboxIndex = index;
            document.getElementById('lb-image').src = imageOnly[index];
            document.getElementById('receipt-lightbox').classList.add('active');
        }

        function closeLightbox(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('receipt-lightbox').classList.remove('active');
        }

        function navigateLightbox(direction) {
            lightboxIndex = (lightboxIndex + direction + lightboxUrls.length) % lightboxUrls.length;
            document.getElementById('lb-image').src = lightboxUrls[lightboxIndex];
        }

        // Export CSV with new fields
        function exportExpensesCSV() {
            if (!allExpenses.length) {
                showExpenseAlert('No expenses to export', 'error');
                return;
            }

            const headers = ['Date', 'Property', 'Category', 'Amount', 'Vendor', 'Martin Hours', 'Colette Hours', 'Miles', 'Notes', 'Receipts'];
            const rows = allExpenses.map(e => [
                e.expense_date,
                `"${(e.property_name || '').replace(/"/g, '""')}"`,
                e.category,
                e.amount,
                `"${(e.vendor || '').replace(/"/g, '""')}"`,
                e.martin_hours || '',
                e.colette_hours || '',
                e.miles || '',
                `"${(e.notes || '').replace(/"/g, '""')}"`,
                `"${(e.receipt_urls || []).join(' | ')}"`
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => csv += row.join(',') + '\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Download receipts as ZIP ‚Äî filename: PropertyName_YYMMDD_Amount.ext
        async function downloadAllReceipts() {
            const withReceipts = allExpenses.filter(e => e.receipt_urls && e.receipt_urls.length);

            if (!withReceipts.length) {
                showExpenseAlert('No receipts found in current view', 'error');
                return;
            }

            const totalFiles = withReceipts.reduce((sum, e) => sum + e.receipt_urls.length, 0);
            showExpenseAlert(`Downloading ${totalFiles} receipt(s)... please wait`, 'success');

            try {
                const zip = new JSZip();
                let downloaded = 0;

                for (const expense of withReceipts) {
                    for (let i = 0; i < expense.receipt_urls.length; i++) {
                        const url = expense.receipt_urls[i];

                        // Build filename: PropertyName_YYMMDD_Amount.ext
                        const safeProp = (expense.property_name || 'unknown').replace(/[^a-zA-Z0-9]/g, '-').replace(/-+/g, '-').substring(0, 50);
                        const d = expense.expense_date || '000000';
                        const yy = d.substring(2, 4);
                        const mm = d.substring(5, 7);
                        const dd = d.substring(8, 10);
                        const yymmdd = `${yy}${mm}${dd}`;
                        const amt = parseFloat(expense.amount || 0).toFixed(2);
                        const origExt = url.split('.').pop().split('?')[0] || 'jpg';
                        const ext = origExt.length > 5 ? 'jpg' : origExt;
                        const suffix = expense.receipt_urls.length > 1 ? `_${i + 1}` : '';
                        const fileName = `${safeProp}_${yymmdd}_${amt}${suffix}.${ext}`;

                        try {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('Failed to fetch');
                            const blob = await response.blob();
                            zip.file(fileName, blob);
                            downloaded++;
                        } catch (fetchErr) {
                            console.warn('Could not download receipt:', url, fetchErr);
                        }
                    }
                }

                if (downloaded === 0) {
                    showExpenseAlert('Could not download any receipt files', 'error');
                    return;
                }

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = `receipts_${new Date().toISOString().split('T')[0]}.zip`;
                link.click();
                URL.revokeObjectURL(link.href);

                showExpenseAlert(`Downloaded ${downloaded} receipt(s) as ZIP`, 'success');
            } catch (error) {
                console.error('Error creating ZIP:', error);
                showExpenseAlert('Error downloading receipts: ' + error.message, 'error');
            }
        }

        function showExpenseAlert(message, type) {
            const container = document.getElementById('expense-alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 4000);
        }

        // ============ PAYMENTS ============

        let paymentDefaults = [];
        let monthlyPayments = [];
        let currentPaymentMonth = new Date();
        currentPaymentMonth.setDate(1);

        // Format month for display
        function formatMonthLabel(date) {
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }

        // Format month as YYYY-MM
        function getMonthKey(date) {
            return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        }

        // Navigate months
        function changePaymentMonth(direction) {
            currentPaymentMonth.setMonth(currentPaymentMonth.getMonth() + direction);
            document.getElementById('payment-month-label').textContent = formatMonthLabel(currentPaymentMonth);
            loadMonthlyPayments();
        }

        // Toggle setup panel
        function togglePaymentSetup() {
            const container = document.getElementById('payment-setup-container');
            container.classList.toggle('visible');
            if (container.classList.contains('visible')) {
                loadPaymentDefaults();
            }
        }

        // Load properties into payment setup dropdown
        async function loadPaymentProperties() {
            try {
                const { data: properties, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .eq('status', 'active')
                    .order('property_name', { ascending: true });

                if (error) throw error;

                const dropdown = document.getElementById('pd-property');
                dropdown.innerHTML = '<option value="">Select Property</option>';

                const buildings = properties.filter(p => p.is_building_level);
                const units = properties.filter(p => !p.is_building_level);

                if (buildings.length) {
                    const g = document.createElement('optgroup');
                    g.label = 'üè¢ Buildings';
                    buildings.forEach(p => {
                        const o = document.createElement('option');
                        o.value = p.property_name;
                        o.textContent = p.property_name;
                        g.appendChild(o);
                    });
                    dropdown.appendChild(g);
                }

                if (units.length) {
                    const g = document.createElement('optgroup');
                    g.label = 'üè† Units';
                    units.forEach(p => {
                        const o = document.createElement('option');
                        o.value = p.property_name;
                        o.textContent = p.property_name;
                        g.appendChild(o);
                    });
                    dropdown.appendChild(g);
                }
            } catch (error) {
                console.error('Error loading payment properties:', error);
            }
        }

        // Save payment default
        async function savePaymentDefault(event) {
            event.preventDefault();

            const pdId = document.getElementById('pd-id').value;
            const data = {
                type: document.getElementById('pd-type').value,
                label: document.getElementById('pd-label').value,
                property_name: document.getElementById('pd-property').value,
                default_amount: parseFloat(document.getElementById('pd-amount').value),
                due_day: parseInt(document.getElementById('pd-due-day').value)
            };

            try {
                if (pdId) {
                    const { error } = await supabaseClient
                        .from('payment_defaults')
                        .update(data)
                        .eq('id', pdId);
                    if (error) throw error;
                    showPaymentAlert('Default updated!', 'success');
                } else {
                    const { error } = await supabaseClient
                        .from('payment_defaults')
                        .insert([data]);
                    if (error) throw error;
                    showPaymentAlert('Default saved!', 'success');
                }

                cancelPdEdit();
                loadPaymentDefaults();
                loadMonthlyPayments();
            } catch (error) {
                console.error('Error saving default:', error);
                showPaymentAlert('Error: ' + error.message, 'error');
            }
        }

        function cancelPdEdit() {
            document.getElementById('payment-default-form').reset();
            document.getElementById('pd-id').value = '';
            document.getElementById('pd-save-btn').textContent = 'Save Default';
        }

        // Load payment defaults
        async function loadPaymentDefaults() {
            try {
                const { data, error } = await supabaseClient
                    .from('payment_defaults')
                    .select('*')
                    .eq('status', 'active')
                    .order('type', { ascending: true })
                    .order('label', { ascending: true });

                if (error) throw error;
                paymentDefaults = data || [];
                renderPaymentDefaults();
            } catch (error) {
                console.error('Error loading defaults:', error);
            }
        }

        function renderPaymentDefaults() {
            const tbody = document.getElementById('pd-tbody');
            if (!paymentDefaults.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No defaults set up yet ‚Äî add one above</td></tr>';
                return;
            }

            tbody.innerHTML = paymentDefaults.map(d => `
                <tr>
                    <td><span class="status-badge" style="background:${d.type === 'rent' ? '#d1fae5;color:#065f46' : '#dbeafe;color:#1e40af'}">${d.type === 'rent' ? 'üè† Rent' : 'üè¶ Mortgage'}</span></td>
                    <td><strong>${d.label}</strong></td>
                    <td>${d.property_name}</td>
                    <td>$${parseFloat(d.default_amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>${d.due_day}${ordinalSuffix(d.due_day)}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editPaymentDefault(${d.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deletePaymentDefault(${d.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function ordinalSuffix(n) {
            const s = ['th','st','nd','rd'];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        function editPaymentDefault(id) {
            const d = paymentDefaults.find(x => x.id === id);
            if (!d) return;
            document.getElementById('pd-id').value = d.id;
            document.getElementById('pd-type').value = d.type;
            document.getElementById('pd-label').value = d.label;
            document.getElementById('pd-property').value = d.property_name;
            document.getElementById('pd-amount').value = d.default_amount;
            document.getElementById('pd-due-day').value = d.due_day;
            document.getElementById('pd-save-btn').textContent = 'Update Default';
            document.getElementById('payment-setup-container').classList.add('visible');
            window.scrollTo(0, 0);
        }

        async function deletePaymentDefault(id) {
            if (!confirm('Delete this payment default? This won\'t delete past payment records.')) return;
            try {
                const { error } = await supabaseClient
                    .from('payment_defaults')
                    .update({ status: 'inactive' })
                    .eq('id', id);
                if (error) throw error;
                showPaymentAlert('Default removed', 'success');
                loadPaymentDefaults();
                loadMonthlyPayments();
            } catch (error) {
                showPaymentAlert('Error: ' + error.message, 'error');
            }
        }

        // Load monthly payments
        async function loadMonthlyPayments() {
            const monthKey = getMonthKey(currentPaymentMonth);
            document.getElementById('payment-month-label').textContent = formatMonthLabel(currentPaymentMonth);

            try {
                // Get active defaults
                const { data: defaults, error: dErr } = await supabaseClient
                    .from('payment_defaults')
                    .select('*')
                    .eq('status', 'active')
                    .order('due_day', { ascending: true });

                if (dErr) throw dErr;
                paymentDefaults = defaults || [];

                // Get existing payment records for this month
                const { data: payments, error: pErr } = await supabaseClient
                    .from('payments')
                    .select('*')
                    .eq('period', monthKey);

                if (pErr) throw pErr;
                monthlyPayments = payments || [];

                renderMonthlyPayments();
            } catch (error) {
                console.error('Error loading payments:', error);
                showPaymentAlert('Error loading payments: ' + error.message, 'error');
            }
        }

        function renderMonthlyPayments() {
            const unpaidContainer = document.getElementById('payments-unpaid');
            const paidContainer = document.getElementById('payments-paid');

            const unpaidRent = [], unpaidMortgage = [];
            const paidRent = [], paidMortgage = [];
            let rentExpected = 0, rentCollected = 0;
            let mortgageExpected = 0, mortgagePaid = 0;

            paymentDefaults.forEach(d => {
                const existing = monthlyPayments.find(p => p.payment_default_id === d.id);
                const isPaid = existing && existing.date_paid;
                const defaultAmt = parseFloat(d.default_amount);
                const paidAmt = isPaid ? parseFloat(existing.amount_paid || 0) : 0;

                if (d.type === 'rent') {
                    rentExpected += defaultAmt;
                    rentCollected += paidAmt;
                } else {
                    mortgageExpected += defaultAmt;
                    mortgagePaid += paidAmt;
                }

                if (isPaid) {
                    // Paid row (editable)
                    const row = renderPaymentRow(d, existing, true);
                    if (d.type === 'rent') paidRent.push(row);
                    else paidMortgage.push(row);

                    // Check for partial payment ‚Äî remaining goes to unpaid
                    if (paidAmt < defaultAmt) {
                        const remaining = defaultAmt - paidAmt;
                        const partialRow = renderPartialRow(d, existing, remaining);
                        if (d.type === 'rent') unpaidRent.push(partialRow);
                        else unpaidMortgage.push(partialRow);
                    }
                } else {
                    // Fully unpaid
                    const row = renderPaymentRow(d, existing, false);
                    if (d.type === 'rent') unpaidRent.push(row);
                    else unpaidMortgage.push(row);
                }
            });

            // Build unpaid HTML
            let unpaidHtml = '';
            if (unpaidRent.length) {
                unpaidHtml += '<div style="font-size:13px;font-weight:600;color:var(--text-secondary);padding:8px 0 4px;">üè† Rent</div>';
                unpaidHtml += unpaidRent.join('');
            }
            if (unpaidMortgage.length) {
                unpaidHtml += '<div style="font-size:13px;font-weight:600;color:var(--text-secondary);padding:8px 0 4px;' + (unpaidRent.length ? 'margin-top:12px;' : '') + '">üè¶ Mortgage</div>';
                unpaidHtml += unpaidMortgage.join('');
            }
            unpaidContainer.innerHTML = unpaidHtml || '<div style="padding:12px;color:var(--success);font-size:14px;">üéâ Everything is paid this month!</div>';

            // Build paid HTML
            let paidHtml = '';
            if (paidRent.length) {
                paidHtml += '<div style="font-size:13px;font-weight:600;color:var(--text-secondary);padding:8px 0 4px;">üè† Rent</div>';
                paidHtml += paidRent.join('');
            }
            if (paidMortgage.length) {
                paidHtml += '<div style="font-size:13px;font-weight:600;color:var(--text-secondary);padding:8px 0 4px;' + (paidRent.length ? 'margin-top:12px;' : '') + '">üè¶ Mortgage</div>';
                paidHtml += paidMortgage.join('');
            }
            paidContainer.innerHTML = paidHtml || '<div style="padding:12px;color:var(--text-secondary);font-size:14px;">No payments recorded yet</div>';

            // Update summary
            const fmt = (v) => '$' + v.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('ps-rent-expected').textContent = fmt(rentExpected);
            document.getElementById('ps-rent-collected').textContent = fmt(rentCollected);
            document.getElementById('ps-mortgage-expected').textContent = fmt(mortgageExpected);
            document.getElementById('ps-mortgage-paid').textContent = fmt(mortgagePaid);
        }

        // Render a partial/remaining balance row in unpaid
        function renderPartialRow(d, existing, remaining) {
            const paymentId = existing ? existing.id : '';
            return `
                <div class="payment-row" data-default-id="${d.id}" data-payment-id="${paymentId}" style="background:#fef3c7;border-radius:6px;padding:10px;margin:4px 0;">
                    <div class="pr-label">‚ö†Ô∏è ${d.label} <small>(remaining)</small></div>
                    <div class="pr-property">${d.property_name}</div>
                    <div>
                        <input type="number" step="0.01" value="${remaining.toFixed(2)}" id="partial-amt-${d.id}"
                            style="width:100px;">
                    </div>
                    <div class="pr-due">of $${parseFloat(d.default_amount).toFixed(2)}</div>
                    <div>
                        <input type="date" id="partial-date-${d.id}"
                            onchange="addAdditionalPayment(${d.id}, this.value, document.getElementById('partial-amt-${d.id}').value)">
                    </div>
                    <div class="pr-status">
                        <span style="color:#92400e;font-size:12px;">Partial</span>
                    </div>
                </div>
            `;
        }

        function renderPaymentRow(d, existing, isPaid) {
            const amount = existing ? existing.amount_paid : d.default_amount;
            const datePaid = existing ? existing.date_paid || '' : '';
            const paymentId = existing ? existing.id : '';
            const paidClass = isPaid ? 'paid' : '';
            const statusLabel = isPaid 
                ? '<span class="paid-check">‚úì Paid</span>'
                : '<span style="color:var(--danger);font-size:13px;">Unpaid</span>';

            return `
                <div class="payment-row ${paidClass}" data-default-id="${d.id}" data-payment-id="${paymentId}">
                    <div class="pr-label">${d.label}</div>
                    <div class="pr-property">${d.property_name}</div>
                    <div>
                        <input type="number" step="0.01" value="${parseFloat(amount).toFixed(2)}"
                            onchange="updatePaymentAmount(${d.id}, '${paymentId}', this.value)"
                            style="width:100px;">
                    </div>
                    <div class="pr-due">Due: ${d.due_day}${ordinalSuffix(d.due_day)}</div>
                    <div>
                        <input type="date" value="${datePaid}"
                            onchange="markPayment(${d.id}, '${paymentId}', this.value, this.closest('.payment-row').querySelector('input[type=number]').value)">
                    </div>
                    <div class="pr-status">
                        ${statusLabel}
                    </div>
                </div>
            `;
        }

        // Mark a payment (create or update)
        async function markPayment(defaultId, existingPaymentId, datePaid, amount) {
            const monthKey = getMonthKey(currentPaymentMonth);
            const amountPaid = parseFloat(amount);

            try {
                if (existingPaymentId) {
                    // Update existing record
                    const updateData = { date_paid: datePaid || null, amount_paid: amountPaid };
                    const { error } = await supabaseClient
                        .from('payments')
                        .update(updateData)
                        .eq('id', existingPaymentId);
                    if (error) throw error;
                } else {
                    // Create new record
                    const { error } = await supabaseClient
                        .from('payments')
                        .insert([{
                            payment_default_id: defaultId,
                            period: monthKey,
                            amount_paid: amountPaid,
                            date_paid: datePaid || null
                        }]);
                    if (error) throw error;
                }

                loadMonthlyPayments();
            } catch (error) {
                console.error('Error saving payment:', error);
                showPaymentAlert('Error: ' + error.message, 'error');
            }
        }

        // Update just the amount (for partial payments)
        async function updatePaymentAmount(defaultId, existingPaymentId, newAmount) {
            const monthKey = getMonthKey(currentPaymentMonth);
            const amount = parseFloat(newAmount);

            try {
                if (existingPaymentId) {
                    const { error } = await supabaseClient
                        .from('payments')
                        .update({ amount_paid: amount })
                        .eq('id', existingPaymentId);
                    if (error) throw error;
                } else {
                    // Create record without date_paid (still unpaid but amount overridden)
                    const { error } = await supabaseClient
                        .from('payments')
                        .insert([{
                            payment_default_id: defaultId,
                            period: monthKey,
                            amount_paid: amount,
                            date_paid: null
                        }]);
                    if (error) throw error;
                }
                loadMonthlyPayments();
            } catch (error) {
                console.error('Error updating amount:', error);
                showPaymentAlert('Error: ' + error.message, 'error');
            }
        }

        // Additional payment for partial amounts
        async function addAdditionalPayment(defaultId, datePaid, additionalAmount) {
            if (!datePaid) return;
            const monthKey = getMonthKey(currentPaymentMonth);
            const addAmt = parseFloat(additionalAmount);

            try {
                // Find the existing payment record
                const existing = monthlyPayments.find(p => p.payment_default_id === defaultId);
                
                if (existing) {
                    // Add to existing amount
                    const newTotal = parseFloat(existing.amount_paid || 0) + addAmt;
                    const { error } = await supabaseClient
                        .from('payments')
                        .update({ amount_paid: newTotal })
                        .eq('id', existing.id);
                    if (error) throw error;
                } else {
                    // Create new record with this amount
                    const { error } = await supabaseClient
                        .from('payments')
                        .insert([{
                            payment_default_id: defaultId,
                            period: monthKey,
                            amount_paid: addAmt,
                            date_paid: datePaid
                        }]);
                    if (error) throw error;
                }

                showPaymentAlert('Additional payment recorded!', 'success');
                loadMonthlyPayments();
            } catch (error) {
                console.error('Error saving additional payment:', error);
                showPaymentAlert('Error: ' + error.message, 'error');
            }
        }

        function showPaymentAlert(message, type) {
            const container = document.getElementById('payment-alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 4000);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initSupabase();
            loadDashboard();
            loadProperties();  // Load property dropdown
        });
    </script>
</body>
</html>
